@model IEnumerable<QLPhanPhoiThuoc.Models.Entities.TheBHYT>

<table class="medicine-table table-hover">
        <thead>
            <tr>
                <th class="ps-4">Số thẻ BHYT</th>
                <th>Chủ thẻ (Bệnh nhân)</th>
                <th>Thông tin liên hệ</th>
                <th>Thời hạn</th>
                <th>Trạng thái</th> <th class="text-end pe-4">Thao tác</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var item in Model)
        {
            // Kiểm tra hạn dựa trên ngày hiện tại
            bool isExpired = item.NgayHetHan < DateTime.Now;

                    <tr>
                        <td class="ps-4">
                            <span class="fw-bold text-success fs-6">@item.SoTheBHYT</span>
                            <div class="small text-muted">ID: @item.MaThe</div>
                        </td>
                        <td>
                            <div class="fw-bold text-primary">@item.BenhNhan?.TenBenhNhan</div>
                            <div class="small">NS: @(item.BenhNhan?.NgaySinh?.ToString("dd/MM/yyyy") ?? "?")</div>
                        </td>
                        <td>
                            <div><i class="fas fa-id-badge me-1 text-muted"></i>@(item.BenhNhan?.CCCD ?? "---")</div>
                            <div><i class="fas fa-phone me-1 text-muted"></i>@(item.BenhNhan?.SoDienThoai ?? "---")</div>
                        </td>
                        <td>
                            <div>@item.NgayBatDau.ToString("dd/MM/yyyy") <i class="fas fa-arrow-right mx-1 small"></i> @item.NgayHetHan.ToString("dd/MM/yyyy")</div>
                        </td>
                        <td>
                    @if (isExpired)
                    {
                        <span class="badge bg-danger">Hết hạn</span>
                    }
                    else
                    {
                        <span class="badge bg-success">Còn hạn</span>
                    }
                        </td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-outline-info" title="Xem chi tiết" onclick="viewBHYTDetail('@item.MaThe')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
        }
        </tbody>
    </table>


    <div class="modal fade" id="commonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="commonModalTitle">Thông tin</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" id="commonModalBody">
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            </div>
        </div>
    </div>
</div>


    <script>
    // --- HÀM TÌM KIẾM BHYT ---
    function searchBHYT() {
        var val = $('#bhytSearch').val();
        // Gọi hàm loadPatientsContent (đã có sẵn trong AdminIndex)
        loadPatientsContent('/Admin/TheBHYT/_DSTheBHYT?search=' + encodeURIComponent(val));
    }

    // --- HÀM XEM CHI TIẾT BHYT ---
    function viewBHYTDetail(id) {
        console.log("Đang xem chi tiết thẻ ID: " + id); // Kiểm tra xem hàm có chạy không

        $.get('/Admin/TheBHYT/Detail/' + id, function(data) {
            // 1. Đổ dữ liệu vào Modal
            $('#commonModalBody').html(data);

            // 2. Sửa tiêu đề Modal
            $('#commonModalTitle').html('<i class="fas fa-info-circle me-2"></i>Chi tiết thẻ BHYT');

            // 3. Hiện Modal lên
            var modalEl = document.getElementById('commonModal');
            if (modalEl) {
                new bootstrap.Modal(modalEl).show();
            } else {
                alert("Lỗi: Không tìm thấy khung Modal (commonModal) trong AdminIndex!");
            }
        }).fail(function() {
            // Nếu lỗi thì dùng Swal (nếu có) hoặc alert
            if (typeof Swal !== 'undefined') {
                Swal.fire('Lỗi', 'Không thể tải thông tin chi tiết. Kiểm tra lại Controller.', 'error');
            } else {
                alert('Lỗi: Không thể tải thông tin chi tiết.');
            }
        });
    }
</script>
