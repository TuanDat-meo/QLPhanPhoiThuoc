@model IEnumerable<QLPhanPhoiThuoc.Models.Entities.BenhNhan>

@{
    ViewData["Title"] = "Danh sách bệnh nhân";

    // Lấy thông tin phân trang từ ViewBag
    int pageNumber = ViewBag.PageNumber ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    int totalItems = ViewBag.TotalItems ?? 0;
    int totalPages = ViewBag.TotalPages ?? 1;
    string currentFilter = ViewBag.CurrentFilter ?? "";

    int firstItem = totalItems > 0 ? ((pageNumber - 1) * pageSize + 1) : 0;
    int lastItem = Math.Min(pageNumber * pageSize, totalItems);
}

<div class="card shadow-sm border-0 animate-fadeIn">
    <div class="card-body p-0">
        <div class="p-3 d-flex justify-content-between align-items-center bg-light border-bottom">
            <div class="search-box w-50">
                <form method="get" id="searchForm">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" 
                               name="searchString" 
                               id="patientSearchInput" 
                               class="form-control border-start-0 ps-0" 
                               placeholder="Tìm kiếm theo tên, CCCD hoặc số điện thoại..." 
                               value="@currentFilter">
                        <button class="btn btn-primary" type="submit">Tìm</button>
                    </div>
                </form>
            </div>
            <div class="filter-options d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="exportPatientExcel()">
                    <i class="fas fa-file-excel me-1"></i> Xuất Excel
                </button>
                <button class="btn btn-light btn-sm" onclick="reloadPatientList()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Thông tin phân trang -->
        @if (totalItems > 0)
        {
                <div class="p-3 pb-0">
                    <p class="text-muted mb-0">
                        Hiển thị <strong>@firstItem</strong> - <strong>@lastItem</strong> 
                        trong tổng số <strong>@totalItems</strong> bệnh nhân
                        (Trang <strong>@pageNumber</strong> / <strong>@totalPages</strong>)
                    </p>
                </div>
        }

        <div class="table-responsive">
            @if (Model != null && Model.Any())
            {
                    <table class="table table-hover align-middle mb-0" id="patientTable">
                        <thead class="bg-gradient-primary text-white">
                            <tr>
                                <th class="ps-4">Mã BN</th>
                                <th>Họ và Tên</th>
                                <th>Ngày sinh</th>
                                <th>Giới tính</th>
                                <th>Số điện thoại</th>
                                <th>Trạng thái</th>
                                <th class="text-end pe-4">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody class="searchable-items">
                        @foreach (var item in Model)
                        {
                                    <tr class="searchable-item">
                                        <td class="ps-4 fw-bold text-primary">@item.MaBenhNhan</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm me-2 bg-info-light text-info rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold">@item.TenBenhNhan</div>
                                            @if (!string.IsNullOrEmpty(item.Email))
                                            {
                                                            <div class="text-muted small">@item.Email</div>
                                            }
                                                </div>
                                            </div>
                                        </td>
                                        <td class="format-date">@(item.NgaySinh.HasValue ? item.NgaySinh.Value.ToString("dd/MM/yyyy") : "")</td>
                                        <td>
                                    @if (item.GioiTinh == "Nam")
                                    {
                                                    <span class="badge bg-info">Nam</span>
                                    }
                                    else
                                    {
                                                    <span class="badge bg-danger">Nữ</span>
                                    }
                                        </td>
                                        <td>@item.SoDienThoai</td>
                                        <td>
                                    @if (item.TrangThai == "DangDieuTri")
                                    {
                                                    <span class="badge bg-success">Đang điều trị</span>
                                    }
                                    else if (item.TrangThai == "DaRaVien")
                                    {
                                                    <span class="badge bg-secondary">Đã ra viện</span>
                                    }
                                    else
                                    {
                                                    <span class="badge bg-info">@item.TrangThai</span>
                                    }
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-light text-primary" title="Xem chi tiết" onclick="viewPatientDetail('@item.MaBenhNhan')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-light text-danger btn-delete" title="Xóa">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                        }
                        </tbody>
                    </table>
            }
            else
            {
                    <div class="alert alert-warning m-3 text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i> 
                        Không tìm thấy dữ liệu bệnh nhân nào phù hợp.
                    </div>
            }
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
                <div class="d-flex justify-content-center mt-4 mb-3">
                    <nav>
                        <ul class="pagination">
                            <!-- First Page -->
                            <li class="page-item @(pageNumber == 1 ? "disabled" : "")">
                                <a class="page-link" href="javascript:void(0)" data-page="1">«</a>
                            </li>

                            <!-- Previous Page -->
                            <li class="page-item @(pageNumber == 1 ? "disabled" : "")">
                                <a class="page-link" href="javascript:void(0)" data-page="@(pageNumber - 1)">‹ Trước</a>
                            </li>

                            <!-- Page Numbers -->
                        @{
                            int startPage = Math.Max(1, pageNumber - 2);
                            int endPage = Math.Min(totalPages, pageNumber + 2);
                        }

                        @for (int i = startPage; i <= endPage; i++)
                        {
                                    <li class="page-item @(i == pageNumber ? "active" : "")">
                                        <a class="page-link" href="javascript:void(0)" data-page="@i">@i</a>
                                    </li>
                        }

                            <!-- Next Page -->
                            <li class="page-item @(pageNumber >= totalPages ? "disabled" : "")">
                                <a class="page-link" href="javascript:void(0)" data-page="@(pageNumber + 1)">Sau ›</a>
                            </li>

                            <!-- Last Page -->
                            <li class="page-item @(pageNumber >= totalPages ? "disabled" : "")">
                                <a class="page-link" href="javascript:void(0)" data-page="@totalPages">»</a>
                            </li>
                        </ul>
                    </nav>
                </div>
        }

        @if (Model != null && Model.Any())
        {
                <div class="p-3 border-top d-flex justify-content-between align-items-center bg-light">
                    <span class="text-muted small">Hiển thị @Model.Count() bản ghi trên trang này</span>
                </div>
        }
    </div>
</div>


<!-- Modal for Patient Details/Edit -->
<div class="modal fade" id="patientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="modalContent">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>


<style>
    .pagination {
        margin-bottom: 0;
    }

    .page-link {
        color: #1e3a5f;
        border: 1px solid #dee2e6;
        padding: 0.5rem 0.75rem;
        margin: 0 2px;
        border-radius: 5px;
        cursor: pointer;
    }

    .page-link:hover {
        background-color: #1e3a5f;
        color: white;
        border-color: #1e3a5f;
    }

    .page-item.active .page-link {
        background-color: #1e3a5f;
        border-color: #1e3a5f;
        color: white;
    }

    .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #dee2e6;
        cursor: not-allowed;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
    }
</style>