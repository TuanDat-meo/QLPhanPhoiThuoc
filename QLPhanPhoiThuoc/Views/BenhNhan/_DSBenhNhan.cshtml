@model IEnumerable<QLPhanPhoiThuoc.Models.Entities.BenhNhan>

<div class="medicine-table-card animate-fadeIn">
    <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
        <div class="search-box w-50">
            <form onsubmit="searchPatients(); return false;">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" id="patientSearch" class="form-control border-start-0 ps-0" 
                           placeholder="Tên, SĐT hoặc mã BHYT..." value="@ViewBag.Search">
                    <button class="btn btn-primary" type="button" onclick="searchPatients()">Tìm</button>
                </div>
            </form>
        </div>
        <button class="btn-add" onclick="loadPatientsContent('/Admin/BenhNhan/Create')">
            <i class="fas fa-user-plus me-2"></i>Tiếp nhận bệnh nhân
        </button>
    </div>

    <table class="medicine-table table-hover">
        <thead>
            <tr>
                <th class="ps-4">Mã BN</th>
                <th>Họ và tên</th>
                <th>Ngày sinh (Tuổi)</th>
                <th>Giới tính</th>
                <th>SĐT / BHYT</th>
                <th>Trạng thái</th>
                <th class="text-end pe-4">Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                var tuoi = item.NgaySinh.HasValue ? (DateTime.Now.Year - item.NgaySinh.Value.Year).ToString() : "?";
                <tr>
                    <td class="ps-4 fw-bold text-primary">@item.MaBenhNhan</td>
                    <td>
                        <div class="fw-bold">@item.TenBenhNhan</div>
                        <div class="small text-muted text-truncate" style="max-width: 200px;" title="@item.DiaChi">
                            <i class="fas fa-map-marker-alt me-1"></i>@(item.DiaChi ?? "---")
                        </div>
                    </td>
                    <td>
                        @(item.NgaySinh?.ToString("dd/MM/yyyy") ?? "--/--/----") 
                        <span class="badge bg-light text-dark border ms-1">@tuoi tuổi</span>
                    </td>
                    <td>
                        @if(item.GioiTinh == "Nam") { <span class="text-primary"><i class="fas fa-mars"></i> Nam</span> }
                        else { <span class="text-danger"><i class="fas fa-venus"></i> Nữ</span> }
                    </td>
                    <td>
                        <div><i class="fas fa-phone-alt me-1 text-muted small"></i>@item.SoDienThoai</div>
                                        @{
                                            // Lấy thẻ BHYT đầu tiên (hoặc thẻ còn hạn nếu có logic đó)
                                            var theBHYT = item.TheBHYTs?.FirstOrDefault()?.MaThe;
                                        }
                                        @if (!string.IsNullOrEmpty(theBHYT))
                                        {
                                <div class="text-success small fw-bold mt-1">
                                    <i class="fas fa-id-card me-1"></i>@theBHYT
                                </div>
                                        }
                                        else
                                        {
                                 <div class="text-muted small mt-1 fst-italic">-- Không có BHYT --</div>
                                        }
                    </td>
                    <td>
                        @if (item.TrangThai == "DangDieuTri") { <span class="badge bg-success">Đang điều trị</span> }
                        else { <span class="badge bg-secondary">Ngừng theo dõi</span> }
                    </td>
                    <td class="text-end pe-4">
                        <button class="btn-action btn-edit" title="Sửa hồ sơ" onclick="editPatient('@item.MaBenhNhan')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action" style="background: #ef4444; color: white" title="Xóa" onclick="deletePatient('@item.MaBenhNhan')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    
    <div class="p-3 border-top d-flex justify-content-between align-items-center bg-light">
        <div class="small text-muted">Trang @ViewBag.CurrentPage / @ViewBag.TotalPages</div>
        <nav>
            <ul class="pagination pagination-sm m-0">
                <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="javascript:void(0)" onclick="loadPatientsContent('/Admin/BenhNhan/_DSBenhNhan?page=@(ViewBag.CurrentPage - 1)&search=@ViewBag.Search')">Trước</a>
                </li>
                @for (int i = 1; i <= ViewBag.TotalPages; i++) {
                    <li class="page-item @(ViewBag.CurrentPage == i ? "active" : "")">
                        <a class="page-link" href="javascript:void(0)" onclick="loadPatientsContent('/Admin/BenhNhan/_DSBenhNhan?page=@i&search=@ViewBag.Search')">@i</a>
                    </li>
                }
                <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                    <a class="page-link" href="javascript:void(0)" onclick="loadPatientsContent('/Admin/BenhNhan/_DSBenhNhan?page=@(ViewBag.CurrentPage + 1)&search=@ViewBag.Search')">Sau</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<div class="modal fade" id="commonModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white" style="background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);">
                <h5 class="modal-title" id="commonModalTitle">Thông tin</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-0" id="commonModalBody">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    }


<script>
    function searchPatients() {
        var val = $('#patientSearch').val();
        loadPatientsContent('/Admin/BenhNhan/_DSBenhNhan?search=' + encodeURIComponent(val));
    }

    function editPatient(id) {
        $.get('/Admin/BenhNhan/Edit/' + id, function(data) {

            $('#commonModalBody').html(data);

            // 3. Đặt tiêu đề cho Modal
            $('#commonModalTitle').html('<i class="fas fa-user-injured me-2"></i>Cập nhật hồ sơ bệnh nhân');

            // 4. Hiển thị Modal lên màn hình
            // (Lưu ý: Phải có khung commonModal ở AdminIndex thì mới hiện được)
            var modalEl = document.getElementById('commonModal');
            if(modalEl) {
                new bootstrap.Modal(modalEl).show();
            } else {
                alert('Lỗi: Không tìm thấy khung Modal trong AdminIndex!');
            }
        });
    }

    function deletePatient(id) {
        Swal.fire({
            title: 'Xóa hồ sơ?',
            text: "Nếu bệnh nhân đã có lịch sử khám, hồ sơ sẽ được lưu trữ thay vì xóa vĩnh viễn.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Đồng ý xóa'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Admin/BenhNhan/Delete/' + id,
                    type: 'POST',
                    success: function(res) {
                        if (res.success) {
                            showToast(res.message, 'success');
                            searchPatients(); // Reload list
                        } else {
                            Swal.fire('Lỗi', res.message, 'error');
                        }
                    }
                });
            }
        })
    }
</script>