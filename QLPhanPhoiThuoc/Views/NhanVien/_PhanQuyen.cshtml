@model IEnumerable<QLPhanPhoiThuoc.Models.Entities.NhanVien>

<div class="medicine-table-card animate-fadeIn">
    <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
        <h5 class="m-0 text-primary"><i class="fas fa-user-shield me-2"></i>Phân quyền hệ thống</h5>
        <div class="search-box w-50">
            <div class="input-group">
                <input type="text" id="roleSearch" class="form-control" placeholder="Tìm nhân viên..." value="@ViewBag.Search">
                <button class="btn btn-primary" onclick="searchRoles()">Tìm</button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="medicine-table table-hover">
            <thead>
                <tr>
                    <th class="ps-4">Nhân viên</th>
                    <th>Tài khoản</th>
                    <th>Vai trò hiện tại</th>
                    <th>Trạng thái TK</th>
                    <th class="text-end pe-4">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    bool hasAccount = item.TaiKhoan != null;
                    bool isMe = item.MaNhanVien == ViewBag.CurrentUserId;

                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle me-2 bg-primary text-white d-flex align-items-center justify-content-center rounded-circle" style="width:35px;height:35px">
                                    @(item.TenNhanVien.Substring(0, 1))
                                    </div>
                                    <div>
                                        <div class="fw-bold">@item.TenNhanVien</div>
                                        <div class="small text-muted">@item.ChucVu - @(item.KhoaPhong?.TenKhoa ?? "---")</div>
                                    </div>
                                </div>
                            </td>

                        @if (hasAccount)
                        {
                                    <td><span class="fw-bold text-primary">@item.TaiKhoan.Username</span></td>
                                    <td>
                                        <select class="form-select form-select-sm border-0 bg-light fw-bold text-dark" id="role_@item.MaNhanVien" @(isMe ? "disabled" : "")>
                                            <option value="Admin" selected="@(item.TaiKhoan.Role == "Admin")">🛡️ Admin (Quản trị)</option>
                                            <option value="BacSi" selected="@(item.TaiKhoan.Role == "BacSi")">👨‍⚕️ Bác sĩ</option>
                                            <option value="DuocSi" selected="@(item.TaiKhoan.Role == "DuocSi")">💊 Dược sĩ</option>
                                            <option value="NhanVien" selected="@(item.TaiKhoan.Role == "NhanVien")">👤 Nhân viên</option>
                                        </select>
                                    </td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="lock_@item.MaNhanVien" 
                                    @(item.TaiKhoan.TrangThai == "Khoa" ? "checked" : "")  @(isMe ? "disabled" : "")>
                                            <label class="form-check-label small" for="lock_@item.MaNhanVien">
                                        @(item.TaiKhoan.TrangThai == "Khoa" ? "Đang khóa" : "Hoạt động")
                                            </label>
                                        </div>
                                    </td>
                                    <td class="text-end pe-4">
                                @if (!isMe)
                                {
                                                <button class="btn btn-sm btn-outline-success" onclick="saveRole('@item.MaNhanVien')">
                                                    <i class="fas fa-save me-1"></i> Lưu
                                                </button>
                                }
                                else
                                {
                                                <span class="badge bg-secondary">Tài khoản của bạn</span>
                                }
                                    </td>
                        }
                        else
                        {
                                    <td colspan="3" class="text-center text-muted fst-italic">
                                        <i class="fas fa-exclamation-circle me-1"></i> Chưa có tài khoản
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-outline-primary" onclick="loadEmployeeContent('/Admin/NhanVien/Edit/@item.MaNhanVien')">
                                            <i class="fas fa-plus me-1"></i> Tạo TK
                                        </button>
                                    </td>
                        }
                        </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    function searchRoles() {
        var val = $('#roleSearch').val();
        loadEmployeeContent('/Admin/NhanVien/PhanQuyen?search=' + encodeURIComponent(val));
    }

    function saveRole(id) {
        var role = $('#role_' + id).val();
        var isLocked = $('#lock_' + id).is(':checked');

        Swal.fire({
            title: 'Xác nhận thay đổi?',
            text: "Quyền hạn của nhân viên sẽ được cập nhật ngay lập tức.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Đồng ý, cập nhật!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Admin/NhanVien/UpdateRole',
                    type: 'POST',
                    data: { maNhanVien: id, newRole: role, isLocked: isLocked },
                    success: function (res) {
                        if (res.success) {
                            showToast(res.message, 'success');
                        } else {
                            Swal.fire('Lỗi', res.message, 'error');
                        }
                    },
                    error: function () {
                        Swal.fire('Lỗi', 'Không thể kết nối server', 'error');
                    }
                });
            }
        });
    }
</script>