@{
    // Dữ liệu từ ViewBag
    var tongBenhNhan = ViewBag.TongBenhNhan ?? 0;
    var tongDonThuoc = ViewBag.TongDonThuoc ?? 0;
    var tongDoanhThu = ViewBag.TongDoanhThu ?? 0;
    var thuocSapHetHan = ViewBag.ThuocSapHetHan ?? 0;
    var benhNhanMoi = ViewBag.BenhNhanMoi ?? 0;
    var donChuaCapPhat = ViewBag.DonChuaCapPhat ?? 0;
    var tongNhanVien = ViewBag.TongNhanVien ?? 0;
    var tongThuoc = ViewBag.TongThuoc ?? 0;
    
    // Biểu đồ
    var doanhThu7Ngay = ViewBag.DoanhThu7Ngay as List<decimal> ?? new List<decimal>();
    var ngay7Ngay = ViewBag.Ngay7Ngay as List<string> ?? new List<string>();
    
    // Phân loại bệnh nhân
    var benhNhanBHYT = ViewBag.BenhNhanBHYT ?? 0;
    var benhNhanVienPhi = ViewBag.BenhNhanVienPhi ?? 0;
    
    // Top 5 thuốc bán chạy
    var top5ThuocBanChay = ViewBag.Top5ThuocBanChay as dynamic ?? new List<dynamic>();
    
    // Hoạt động gần đây
    var hoatDongGanDay = ViewBag.HoatDongGanDay as dynamic ?? new List<dynamic>();
    
    // Thuốc sắp hết tồn kho
    var thuocSapHetTonKho = ViewBag.ThuocSapHetTonKho as dynamic ?? new List<dynamic>();
}

<style>
    /* Section Header */
    .section-header {
        margin-bottom: 25px;
    }

    .section-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1e3a5f;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title i {
        font-size: 1.6rem;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: white;
    }

    .stat-icon.primary {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
    }

    .stat-icon.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .stat-icon.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-icon.danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-details {
        flex: 1;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #1e3a5f;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* Charts */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    .chart-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1e3a5f;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chart-container {
        height: 300px;
        position: relative;
    }

    /* Tables */
    .data-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .table-header {
        padding: 20px 25px;
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
    }

    .table-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1e3a5f;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .modern-table {
        width: 100%;
        border-collapse: collapse;
    }

    .modern-table thead {
        background: #1e3a5f;
        color: white;
    }

    .modern-table th {
        padding: 15px 20px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .modern-table td {
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        color: #495057;
    }

    .modern-table tbody tr {
        transition: all 0.2s ease;
    }

    .modern-table tbody tr:hover {
        background: #f8f9fa;
    }

    /* Status Badges */
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }

    .status-success {
        background: #d4edda;
        color: #155724;
    }

    .status-warning {
        background: #fff3cd;
        color: #856404;
    }

    .status-danger {
        background: #f8d7da;
        color: #721c24;
    }

    .status-info {
        background: #d1ecf1;
        color: #0c5460;
    }

    /* Responsive */
    @@media (max-width: 992px) {
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .charts-grid {
            grid-template-columns: 1fr;
        }
    }

    @@media (max-width: 576px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<!-- Dashboard Content -->
<div class="section-header">
    <h2 class="section-title">
        <i class="fas fa-chart-line"></i>
        Tổng quan hệ thống
    </h2>
</div>

<!-- Stats Row 1 -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-user-injured"></i>
        </div>
        <div class="stat-details">
            <div class="stat-value">@tongBenhNhan.ToString("N0")</div>
            <div class="stat-label">Tổng bệnh nhân</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-pills"></i>
        </div>
        <div class="stat-details">
            <div class="stat-value">@tongThuoc</div>
            <div class="stat-label">Loại thuốc</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-prescription"></i>
        </div>
        <div class="stat-details">
            <div class="stat-value">@donChuaCapPhat</div>
            <div class="stat-label">Đơn chờ cấp phát</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon danger">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-details">
            <div class="stat-value">@thuocSapHetHan</div>
            <div class="stat-label">Thuốc sắp hết hạn</div>
        </div>
    </div>
</div>

<!-- Stats Row 2 -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-file-invoice-dollar"></i>
        </div>
        <div class="stat-details">
            <div class="stat-value">@tongDoanhThu.ToString("N0")</div>
            <div class="stat-label">Doanh thu (VNĐ)</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-user-plus"></i>
        </div>
        <div class="stat-details">
            <div class="stat-value">@benhNhanMoi</div>
            <div class="stat-label">Bệnh nhân mới tháng này</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-receipt"></i>
        </div>
        <div class="stat-details">
            <div class="stat-value">@tongDonThuoc.ToString("N0")</div>
            <div class="stat-label">Tổng đơn thuốc</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-user-tie"></i>
        </div>
        <div class="stat-details">
            <div class="stat-value">@tongNhanVien</div>
            <div class="stat-label">Nhân viên</div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="charts-grid">
    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">
                <i class="fas fa-chart-area"></i>
                Doanh thu 7 ngày gần nhất
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <h3 class="chart-title">
                <i class="fas fa-chart-pie"></i>
                Phân loại bệnh nhân
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="patientChart"></canvas>
        </div>
    </div>
</div>

<!-- Tables Grid -->
<div class="charts-grid">
    <!-- Top 5 Thuốc bán chạy -->
    <div class="data-table">
        <div class="table-header">
            <h3 class="table-title">
                <i class="fas fa-fire"></i>
                Top 5 Thuốc bán chạy
            </h3>
        </div>
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>Tên thuốc</th>
                        <th>Số lượng</th>
                    </tr>
                </thead>
                <tbody>
                    @if (top5ThuocBanChay != null && top5ThuocBanChay.Count > 0)
                    {
                        foreach (var thuoc in top5ThuocBanChay)
                        {
                            <tr>
                                <td>@thuoc.TenThuoc</td>
                                <td>
                                    <span class="status-badge status-success">
                                        @thuoc.SoLuong
                                    </span>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="2" style="text-align: center; color: #6c757d;">
                                Chưa có dữ liệu
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Thuốc sắp hết tồn kho -->
    <div class="data-table">
        <div class="table-header">
            <h3 class="table-title">
                <i class="fas fa-exclamation-triangle"></i>
                Thuốc cần nhập thêm
            </h3>
        </div>
        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>Tên thuốc</th>
                        <th>Tồn kho</th>
                        <th>Tối thiểu</th>
                    </tr>
                </thead>
                <tbody>
                    @if (thuocSapHetTonKho != null && thuocSapHetTonKho.Count > 0)
                    {
                        foreach (var thuoc in thuocSapHetTonKho)
                        {
                            <tr>
                                <td>@thuoc.TenThuoc</td>
                                <td>
                                    <span class="status-badge status-danger">
                                        @thuoc.TonKhoHienTai
                                    </span>
                                </td>
                                <td>@thuoc.TonKhoToiThieu</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="3" style="text-align: center; color: #6c757d;">
                                Tất cả thuốc đều đủ tồn kho
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Hoạt động gần đây -->
<div class="data-table" style="margin-top: 25px;">
    <div class="table-header">
        <h3 class="table-title">
            <i class="fas fa-history"></i>
            Hoạt động gần đây
        </h3>
    </div>
    <div class="table-responsive">
        <table class="modern-table">
            <thead>
                <tr>
                    <th>Mã đơn</th>
                    <th>Ngày kê đơn</th>
                    <th>Loại đơn</th>
                    <th>Bệnh nhân</th>
                    <th>Bác sĩ</th>
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody>
                @if (hoatDongGanDay != null && hoatDongGanDay.Count > 0)
                {
                    foreach (var hoatDong in hoatDongGanDay)
                    {
                        string statusClass = hoatDong.TrangThai == "DaCapPhat" ? "status-success" :
                                           hoatDong.TrangThai == "ChoCapPhat" ? "status-warning" : "status-info";
                        <tr>
                            <td>@hoatDong.MaDonThuoc</td>
                            <td>@hoatDong.NgayKeDon.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@hoatDong.LoaiDon</td>
                            <td>@hoatDong.BenhNhan</td>
                            <td>@hoatDong.BacSi</td>
                            <td>
                                <span class="status-badge @statusClass">
                                    @hoatDong.TrangThai
                                </span>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" style="text-align: center; color: #6c757d;">
                            Chưa có hoạt động nào
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Chart Initialization Script -->
<script>
    // Đảm bảo Chart.js đã được load
    if (typeof Chart !== 'undefined') {
        // Khởi tạo charts khi DOM ready
        setTimeout(function() {
            initializeDashboardCharts();
        }, 100);
    } else {
        console.error('Chart.js is not loaded. Please include Chart.js library.');
    }

    function initializeDashboardCharts() {
        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart');
        if (revenueCtx) {
            // Destroy existing chart if any
            if (window.revenueChartInstance) {
                window.revenueChartInstance.destroy();
            }
            
            window.revenueChartInstance = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(ngay7Ngay)),
                    datasets: [{
                        label: 'Doanh thu (triệu VNĐ)',
                        data: @Html.Raw(Json.Serialize(doanhThu7Ngay)),
                        borderColor: '#1e3a5f',
                        backgroundColor: 'rgba(30, 58, 95, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#1e3a5f',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(30, 58, 95, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#1e3a5f',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh thu: ' + context.parsed.y.toFixed(2) + ' triệu VNĐ';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + 'M';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Patient Chart
        const patientCtx = document.getElementById('patientChart');
        if (patientCtx) {
            // Destroy existing chart if any
            if (window.patientChartInstance) {
                window.patientChartInstance.destroy();
            }
            
            const totalPatients = @benhNhanBHYT + @benhNhanVienPhi;
            const bhytPercent = totalPatients > 0 ? ((@benhNhanBHYT / totalPatients) * 100).toFixed(1) : 0;
            const vienPhiPercent = totalPatients > 0 ? ((@benhNhanVienPhi / totalPatients) * 100).toFixed(1) : 0;
            
            window.patientChartInstance = new Chart(patientCtx, {
                type: 'doughnut',
                data: {
                    labels: ['BHYT', 'Viện phí'],
                    datasets: [{
                        data: [@benhNhanBHYT, @benhNhanVienPhi],
                        backgroundColor: [
                            '#1e3a5f',
                            '#38ef7d'
                        ],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 58, 95, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#1e3a5f',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.parsed;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return context.label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }
    }
</script>
