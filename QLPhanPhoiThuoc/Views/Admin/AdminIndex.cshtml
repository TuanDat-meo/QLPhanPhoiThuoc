@{
    ViewData["Title"] = "Trang quản trị";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var chucVu = ViewBag.ChucVu ?? "Quản trị viên";
    var tenNhanVien = ViewBag.TenNhanVien ?? "Admin";
    var maNhanVien = ViewBag.MaNhanVien ?? "";
    var userRole = User.FindFirst(System.Security.Claims.ClaimTypes.Role)?.Value ?? "Admin";
}

<style>
     .admin-container {
        display: flex;
        gap: 25px;
        min-height: calc(100vh - 200px);
        padding: 20px;
    }

    /* ==================== COMPACT SIDEBAR ==================== */
    .sidebar {
        width: 260px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 0;
        height: fit-content;
        max-height: calc(100vh - 140px);
        overflow-y: auto;
        position: sticky;
        top: 90px;
    }

    .sidebar::-webkit-scrollbar {
        width: 5px;
    }

    .sidebar::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .sidebar::-webkit-scrollbar-thumb {
        background: #1e3a5f;
        border-radius: 10px;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        border-radius: 12px 12px 0 0;
        color: white;
    }

    .sidebar-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0;
    }

    .sidebar-subtitle {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-top: 3px;
    }

    /* Menu Accordion */
    .menu-accordion {
        padding: 10px 0;
    }

    .menu-group {
        margin-bottom: 5px;
    }

    .menu-group-header {
        padding: 12px 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
        color: #495057;
        font-weight: 500;
        user-select: none;
    }

    .menu-group-header:hover {
        background: #f8f9fa;
        color: #1e3a5f;
        border-left-color: #1e3a5f;
    }

    .menu-group-header.active {
        background: linear-gradient(90deg, rgba(30,58,95,0.1) 0%, transparent 100%);
        color: #1e3a5f;
        border-left-color: #1e3a5f;
        font-weight: 600;
    }

    .menu-header-content {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .menu-header-content i {
        width: 22px;
        text-align: center;
        font-size: 1.1rem;
    }

    .menu-arrow {
        transition: transform 0.3s ease;
        font-size: 0.85rem;
        color: #6c757d;
    }

    .menu-group-header.active .menu-arrow {
        transform: rotate(90deg);
        color: #1e3a5f;
    }

    /* Submenu */
    .menu-submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: #f8f9fa;
    }

    .menu-submenu.show {
        max-height: 500px;
    }

    .submenu-item {
        padding: 10px 20px 10px 54px;
        color: #6c757d;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        font-size: 0.9rem;
        cursor: pointer;
    }

    .submenu-item:hover {
        background: white;
        color: #1e3a5f;
        border-left-color: #38bdf8;
        text-decoration: none;
        padding-left: 58px;
    }

    .submenu-item.active {
        background: white;
        color: #1e3a5f;
        border-left-color: #1e3a5f;
        font-weight: 600;
    }

    .submenu-item i {
        font-size: 0.75rem;
        width: 12px;
    }

    .menu-badge {
        background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        color: white;
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 600;
        margin-left: auto;
    }

    /* ==================== MAIN CONTENT AREA ==================== */
    .dashboard-content {
        flex: 1;
        min-width: 0;
    }

    /* Content Section */
    .content-section {
        display: none;
    }

    .content-section.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Loading Spinner */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .loading-overlay.show {
        display: flex;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #1e3a5f;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* CSS từ Index.cshtml cho phần quản lý thuốc */
    .medicine-container {
        padding: 25px;
        background: #f8f9fa;
        min-height: calc(100vh - 200px);
    }

    .page-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
        padding: 25px 30px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(30, 58, 95, 0.3);
    }

    .filter-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .filter-group label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-group input,
    .filter-group select {
        padding: 10px 14px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s;
    }

    .filter-group input:focus,
    .filter-group select:focus {
        border-color: #1e3a5f;
        outline: none;
        box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
    }

    .btn-filter,
    .btn-reset {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
    }

    .btn-filter {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
    }

    .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
    }

    .btn-reset {
        background: #6c757d;
        color: white;
    }

    .btn-reset:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .result-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #6c757d;
        font-size: 0.95rem;
    }

    .btn-add {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
    }

    .btn-add:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
        text-decoration: none;
        color: white;
    }

    .medicine-table-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    .medicine-table {
        width: 100%;
        border-collapse: collapse;
    }

    .medicine-table thead {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
    }

    .medicine-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .medicine-table th.sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 30px;
    }

    .medicine-table th.sortable:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .medicine-table th.sortable::after {
        content: "⇅";
        position: absolute;
        right: 10px;
        opacity: 0.5;
    }

    .medicine-table th.sorted-asc::after {
        content: "↑";
        opacity: 1;
    }

    .medicine-table th.sorted-desc::after {
        content: "↓";
        opacity: 1;
    }

    .medicine-table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: background 0.2s;
    }

    .medicine-table tbody tr:hover {
        background: #f8f9fa;
    }

    .medicine-table td {
        padding: 14px 16px;
        font-size: 0.95rem;
    }

    .price-cell {
        font-weight: 600;
        color: #11998e;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-success {
        background: rgba(17, 153, 142, 0.15);
        color: #11998e;
        border: 1px solid rgba(17, 153, 142, 0.3);
    }

    .badge-danger {
        background: rgba(251, 113, 133, 0.15);
        color: #f43f5e;
        border: 1px solid rgba(251, 113, 133, 0.3);
    }

    .btn-action {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        text-decoration: none;
        transition: all 0.3s;
        margin: 0 3px;
    }

    .btn-view {
        background: #667eea;
        color: white;
    }

    .btn-view:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-edit {
        background: #f59e0b;
        color: white;
    }

    .btn-edit:hover {
        background: #d97706;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
    }

    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-top: 1px solid #e9ecef;
    }

    .pagination-info {
        color: #6c757d;
        font-size: 0.95rem;
    }

    .pagination {
        display: flex;
        gap: 5px;
    }

    .pagination a,
    .pagination span {
        min-width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        color: #495057;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
        border: 1px solid #dee2e6;
        background: white;
    }

    .pagination a:hover {
        background: #1e3a5f;
        color: white;
        border-color: #1e3a5f;
        transform: translateY(-2px);
    }

    .pagination span.active {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
        border-color: transparent;
    }
</style>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
</div>

<div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">
                <i class="fas fa-user-circle"></i> @tenNhanVien
            </h3>
            <div class="sidebar-subtitle">@chucVu</div>
        </div>

        <nav class="menu-accordion">
            <!-- Dashboard -->
            <div class="menu-group">
                <div class="menu-group-header active" data-section="dashboard">
                    <div class="menu-header-content">
                        <i class="fas fa-th-large"></i>
                        <span>Dashboard</span>
                    </div>
                </div>
            </div>

            <!-- Quản lý thuốc -->
            <div class="menu-group">
                <div class="menu-group-header" data-section="medicines">
                    <div class="menu-header-content">
                        <i class="fas fa-pills"></i>
                        <span>Quản lý thuốc</span>
                    </div>
                    <i class="fas fa-chevron-right menu-arrow"></i>
                </div>
                <div class="menu-submenu">
                    <a href="#" class="submenu-item" data-url="/Admin/Thuoc/Index">
                        <i class="fas fa-circle"></i>
                        <span>Danh sách thuốc</span>
                    </a>
                    <a href="#" class="submenu-item" data-url="/Admin/Thuoc/TonKho">
                        <i class="fas fa-circle"></i>
                        <span>Tồn kho</span>
                    </a>
                    <a href="#" class="submenu-item" data-url="/Admin/Thuoc/CanhBao">
                        <i class="fas fa-circle"></i>
                        <span>Cảnh báo</span>
                    </a>
                    <a href="#" class="submenu-item" data-url="/Admin/Thuoc/ThongKe">
                        <i class="fas fa-circle"></i>
                        <span>Thống kê</span>
                    </a>
                </div>
            </div>

            <!-- Bệnh nhân -->
            <div class="menu-group">
                <div class="menu-group-header" data-section="patients">
                    <div class="menu-header-content">
                        <i class="fas fa-user-injured"></i>
                        <span>Bệnh nhân</span>
                    </div>
                    <i class="fas fa-chevron-right menu-arrow"></i>
                </div>
                <div class="menu-submenu">
                    <a href="#" class="submenu-item" onclick="loadPatientsContent('/Admin/BenhNhan/_DSBenhNhan')">
                        <i class="fas fa-circle"></i>
                        Danh sách bệnh nhân
                    </a>
                    <a href="#" class="submenu-item" onclick="loadPatientsContent('/Admin/BenhNhan/Create')">
                        <i class="fas fa-circle"></i>
                        Quản lý bệnh nhân
                    </a>
                    <a href="#" class="submenu-item" onclick="loadPatientsContent('/Admin/TheBHYT/_DSTheBHYT')">
                                <i class="fas fa-circle"></i>
                                <span>BHYT</span>
                    </a>
                </div>
            </div>

            <!-- Đơn thuốc -->
            <div class="menu-group">
                <div class="menu-group-header" data-section="prescriptions">
                    <div class="menu-header-content">
                        <i class="fas fa-prescription"></i>
                        <span>Đơn thuốc</span>
                    </div>
                    <i class="fas fa-chevron-right menu-arrow"></i>
                </div>
                <div class="menu-submenu">
                    <a href="#" class="submenu-item" data-tab="prescription-list">
                        <i class="fas fa-circle"></i>
                        <span>Danh sách đơn</span>
                    </a>
                    <a href="#" class="submenu-item" data-tab="prescription-pending">
                        <i class="fas fa-circle"></i>
                        <span>Chờ cấp phát</span>
                    </a>
                    <a href="#" class="submenu-item" data-tab="prescription-completed">
                        <i class="fas fa-circle"></i>
                        <span>Đã hoàn thành</span>
                    </a>
                </div>
            </div>

            <!-- Kho -->
            <div class="menu-group">
                <div class="menu-group-header" data-section="warehouse">
                    <div class="menu-header-content">
                        <i class="fas fa-warehouse"></i>
                        <span>Quản lý kho</span>
                    </div>
                    <i class="fas fa-chevron-right menu-arrow"></i>
                </div>
                <div class="menu-submenu">
                    <a href="javascript:void(0)" class="submenu-item" data-url="/Admin/Kho/Index">
                        <i class="fas fa-circle"></i>
                        <span>Danh sách kho</span>
                    </a>
                </div>
            </div>

            <!-- Hóa đơn -->
            <div class="menu-group">
                <div class="menu-group-header" data-section="invoices">
                    <div class="menu-header-content">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Hóa đơn</span>
                    </div>
                    <i class="fas fa-chevron-right menu-arrow"></i>
                </div>
                <div class="menu-submenu">
                    <a href="#" class="submenu-item" data-url="/Admin/HoaDon/_DSHoaDon"> <i class="fas fa-circle"></i>
                        <span>Danh sách hóa đơn</span>
                    </a>
                    <a href="#" class="submenu-item" data-url="/Admin/HoaDon/_HoaDonChoThanhToan">
                        <i class="fas fa-circle"></i>
                        <span>Chờ thanh toán</span>
                    </a>
                    <a href="#" class="submenu-item" data-url="/Admin/HoaDon/_HoaDonDaThanhToan">
                        <i class="fas fa-circle"></i>
                        <span>Đã thanh toán</span>
                    </a>
                </div>
            </div>

            <!-- Nhà cung cấp -->
            <div class="menu-group">
                <div class="menu-group-header" data-section="suppliers">
                    <div class="menu-header-content">
                        <i class="fas fa-truck"></i>
                        <span>Nhà cung cấp</span>
                    </div>
                    <i class="fas fa-chevron-right menu-arrow"></i>
                </div>
                <div class="menu-submenu">
                    <a href="#" class="submenu-item" data-tab="supplier-list">
                        <i class="fas fa-circle"></i>
                        <span>Danh sách NCC</span>
                    </a>
                    <a href="#" class="submenu-item" data-tab="supplier-orders">
                        <i class="fas fa-circle"></i>
                        <span>Đơn đặt hàng</span>
                    </a>
                </div>
            </div>

            @if (userRole == "Admin")
            {
                <!-- Nhân viên (chỉ Admin) -->
                <div class="menu-group">
                    <div class="menu-group-header" data-section="employees">
                        <div class="menu-header-content">
                            <i class="fas fa-users"></i>
                            <span>Nhân viên</span>
                        </div>
                        <i class="fas fa-chevron-right menu-arrow"></i>
                    </div>
                    <div class="menu-submenu">
                        <a href="#" class="submenu-item" data-url="/Admin/NhanVien/_DSNhanVien">
                            <i class="fas fa-circle"></i>
                            <span>Danh sách nhân viên</span>
                        </a>
                        <a href="#" class="submenu-item" onclick="loadEmployeeContent('/Admin/NhanVien/Create')">
                            <i class="fas fa-circle"></i>
                            <span>Thêm nhân viên</span>
                        </a>
                        <a href="#" class="submenu-item" onclick="loadEmployeeContent('/Admin/NhanVien/PhanQuyen')">
                            <i class="fas fa-circle"></i>
                            <span>Phân quyền</span>
                        </a>
                    </div>
                </div>

                <!-- Báo cáo -->
                <div class="menu-group">
                    <div class="menu-group-header" data-section="reports">
                        <div class="menu-header-content">
                            <i class="fas fa-chart-bar"></i>
                            <span>Báo cáo</span>
                        </div>
                        <i class="fas fa-chevron-right menu-arrow"></i>
                    </div>
                    <div class="menu-submenu">
                        <a href="#" class="submenu-item" data-tab="report-revenue">
                            <i class="fas fa-circle"></i>
                            <span>Báo cáo doanh thu</span>
                        </a>
                        <a href="#" class="submenu-item" data-tab="report-inventory">
                            <i class="fas fa-circle"></i>
                            <span>Báo cáo tồn kho</span>
                        </a>
                        <a href="#" class="submenu-item" data-tab="report-usage">
                            <i class="fas fa-circle"></i>
                            <span>Thống kê sử dụng</span>
                        </a>
                    </div>
                </div>
            }

            <!-- Cài đặt -->
            <div class="menu-group">
                <div class="menu-group-header" data-section="settings">
                    <div class="menu-header-content">
                        <i class="fas fa-cog"></i>
                        <span>Cài đặt</span>
                    </div>
                    <i class="fas fa-chevron-right menu-arrow"></i>
                </div>
                <div class="menu-submenu">
                    <a href="#" class="submenu-item" data-tab="settings-general">
                        <i class="fas fa-circle"></i>
                        <span>Cài đặt chung</span>
                    </a>
                    <a href="#" class="submenu-item" data-tab="settings-profile">
                        <i class="fas fa-circle"></i>
                        <span>Hồ sơ cá nhân</span>
                    </a>
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="dashboard-content">
        <!-- Dashboard Section (Default) -->
        <div id="dashboard" class="content-section active">
            <h2>Đang tải...</h2>
        </div>

        <!-- Medicine Management Section -->
        <div id="medicines" class="content-section">
            <div class="medicine-container">
                <div class="page-header">
                    <h2 style="margin: 0; font-size: 1.8rem; font-weight: 700;">Quản lý thuốc</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.95rem;">Quản lý thông tin thuốc trong hệ thống</p>
                </div>
                <div id="medicineContent">
                    <p style="text-align: center; padding: 50px; color: #6c757d;">Chọn một mục từ menu bên trái</p>
                </div>
            </div>
        </div>

        @* Invoices Section *@
        <div id="invoices" class="content-section">
            <div class="medicine-container"> <div class="page-header">
                    <h2 style="margin: 0; font-size: 1.8rem; font-weight: 700;">Quản lý hóa đơn</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.95rem;">Theo dõi thanh toán và doanh thu</p>
                </div>
                <div id="invoiceContent">
                    <p style="text-align: center; padding: 50px; color: #6c757d;">Đang tải dữ liệu...</p>
                </div>
            </div>
        </div>
        @* Nhân Viên *@
        <div id="employees" class="content-section">
            <div class="medicine-container">
                <div class="page-header">
                    <h2 style="margin: 0; font-size: 1.8rem; font-weight: 700;">Quản lý nhân viên</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.95rem;">Quản lý đội ngũ y bác sĩ và nhân viên bệnh viện</p>
                </div>
                <div id="employeeContent">
                    <p style="text-align: center; padding: 50px; color: #6c757d;">Đang tải dữ liệu...</p>
                </div>
            </div>
        </div>
        @* Bệnh nhân *@
        <div id="patients" class="content-section">
            <div class="medicine-container">
                <div class="page-header">
                    <h2 style="margin: 0; font-size: 1.8rem; font-weight: 700;">Quản lý bệnh nhân</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.95rem;">Tiếp nhận và quản lý hồ sơ bệnh án</p>
                </div>
                <div id="patientContent">
                    <p style="text-align: center; padding: 50px; color: #6c757d;">Đang tải dữ liệu...</p>
                </div>
            </div>
        </div>

        <!-- Warehouse Section - PHẦN NÀY QUAN TRỌNG -->
        <div id="warehouse" class="content-section">
            <div id="warehouseContent">
                <p style="text-align: center; padding: 50px; color: #6c757d;">
                    <i class="fas fa-warehouse" style="font-size: 3rem; opacity: 0.3; display: block; margin-bottom: 15px;"></i>
                    Đang tải dữ liệu kho...
                </p>
            </div>
        </div>
    </main>
</div>

@section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="~/js/BenhNhan/BenhNhan.js"></script>
        <script>
            // ==================== GLOBAL VARIABLES & UTILS ====================
            let panelStack = [];
            let currentPanelLevel = 0;

            function showLoading() { $('#loadingOverlay').addClass('show'); }
            function hideLoading() { $('#loadingOverlay').removeClass('show'); }

            // Hàm chuyển đổi Tab chính (Section)
            function showSection(sectionId) {
                $('.content-section').removeClass('active');
                $('#' + sectionId).addClass('active');
            }

            // ==================== PANEL SYSTEM ====================
            function openPanel(url, title, icon = 'fas fa-file') {
                currentPanelLevel++;
                const panelId = 'panel-' + currentPanelLevel;
                const overlayId = 'overlay-' + currentPanelLevel;
                const overlay = $('<div>', { id: overlayId, class: 'panel-overlay', 'data-level': currentPanelLevel });
                const panel = $('<div>', { id: panelId, class: 'panel-container', 'data-level': currentPanelLevel });

                const header = `<div class="panel-header">
                                    <h4 class="panel-title"><i class="${icon}"></i><span>${title}</span></h4>
                                    <button class="panel-close-btn" onclick="closePanel(${currentPanelLevel})"><i class="fas fa-times"></i></button>
                                </div>`;
                const body = $('<div>', { class: 'panel-body' }).html('<div style="text-align: center; padding: 50px;"><div class="spinner"></div></div>');

                panel.append(header).append(body);
                $('body').append(overlay).append(panel);

                overlay.on('click', function () { closePanel(currentPanelLevel); });
                setTimeout(() => { overlay.addClass('show'); panel.addClass('show'); }, 10);

                $.ajax({
                    url: url, method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function (data) { body.html(data); },
                    error: function (xhr) { body.html(`<div class="alert alert-danger">Lỗi: ${xhr.statusText}</div>`); }
                });
                panelStack.push({ id: panelId, overlayId: overlayId, level: currentPanelLevel });
            }

            function closePanel(level) {
                const panelData = panelStack.find(p => p.level === level);
                if (!panelData) return;
                $('#' + panelData.id).removeClass('show');
                $('#' + panelData.overlayId).removeClass('show');
                setTimeout(() => { $('#' + panelData.id).remove(); $('#' + panelData.overlayId).remove(); }, 400);
                panelStack = panelStack.filter(p => p.level !== level);
                currentPanelLevel = panelStack.length > 0 ? Math.max(...panelStack.map(p => p.level)) : 0;
            }

            // ==================== CONTENT LOADERS ====================

            // 1. Load Bệnh nhân & BHYT
            function loadPatientsContent(url) {
                showLoading();
                showSection('patients'); // Hiện section Bệnh nhân

                $.ajax({
                    url: url,
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function (data) {
                        $('#patientContent').html(data);
                        hideLoading();
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi tải bệnh nhân:', error);
                        $('#patientContent').html('<div class="alert alert-danger">Lỗi tải dữ liệu bệnh nhân</div>');
                        hideLoading();
                    }
                });
            }

            // 2. Load Kho
            function loadWarehouseContent(url) {
                showLoading(); showSection('warehouse');
                $.ajax({
                    url: url, method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function (data) { $('#warehouseContent').html(data); hideLoading(); },
                    error: function () { $('#warehouseContent').html('<div class="alert alert-danger">Lỗi tải kho</div>'); hideLoading(); }
                });
            }

            // 3. Load Nhân viên
            function loadEmployeeContent(url) {
                showLoading(); showSection('employees');
                $.ajax({
                    url: url, method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function (data) { $('#employeeContent').html(data); hideLoading(); },
                    error: function () { $('#employeeContent').html('<div class="alert alert-danger">Lỗi tải nhân viên</div>'); hideLoading(); }
                });
            }

            // 4. Load Hóa đơn
            function loadInvoiceContent(url) {
                showLoading(); showSection('invoices');
                $.ajax({
                    url: url, method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function (data) { $('#invoiceContent').html(data); hideLoading(); },
                    error: function () { $('#invoiceContent').html('<div class="alert alert-danger">Lỗi tải hóa đơn</div>'); hideLoading(); }
                });
            }

            // 5. Load Thuốc (Mặc định cho các link data-url khác)
            function loadThuocContent(url) {
                 // Logic đặc biệt: Mở Panel nếu là Edit/Details
                 if (url.includes('/Details/')) { openPanel(url, 'Chi tiết', 'fas fa-info-circle'); return; }
                 if (url.includes('/Edit/')) { openPanel(url, 'Chỉnh sửa', 'fas fa-edit'); return; }

                 showLoading(); showSection('medicines');
                 $.ajax({
                    url: url, method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    success: function (data) { $('#medicineContent').html(data); hideLoading(); },
                    error: function () { $('#medicineContent').html('<div class="alert alert-danger">Lỗi tải dữ liệu thuốc</div>'); hideLoading(); }
                 });
            }

            // ==================== BHYT FUNCTIONS (QUAN TRỌNG) ====================
            // Được gọi từ View _DSTheBHYT.cshtml và _EditBenhNhan.cshtml

            function searchBHYT() {
                var val = $('#bhytSearch').val();
                loadPatientsContent('/Admin/TheBHYT/_DSTheBHYT?search=' + encodeURIComponent(val));
            }

            function viewBHYTDetail(id) {
                $.get('/Admin/TheBHYT/Detail/' + id, function(data) {
                    // Đổ data vào Common Modal
                    $('#commonModalBody').html(data);
                    $('#commonModalTitle').html('<i class="fas fa-info-circle me-2"></i>Chi tiết thẻ BHYT');
                    new bootstrap.Modal(document.getElementById('commonModal')).show();
                }).fail(function() {
                    alert('Lỗi: Không thể tải thông tin chi tiết. Kiểm tra Controller.');
                });
            }

            // Hàm nhảy từ Form Sửa BN sang Tra cứu BHYT
            function jumpToBHYT() {
                var soThe = $('#txtSoTheBHYT_Edit').val();
                if(!soThe) return;
                $('#commonModal').modal('hide'); // Đóng form sửa
                loadPatientsContent('/Admin/TheBHYT/_DSTheBHYT?search=' + encodeURIComponent(soThe));
            }

            // ==================== DOCUMENT READY (INIT) ====================
            $(document).ready(function () {
                // 1. Load Dashboard mặc định
                $.ajax({
                    url: '/Admin/Dashboard', method: 'GET',
                    success: function(data) { $('#dashboard').html(data); },
                    error: function() { $('#dashboard').html('<div class="p-5 text-center">Lỗi tải Dashboard</div>'); }
                });

                // 2. Xử lý Accordion Menu
                $('.menu-group-header').click(function () {
                    const $header = $(this);
                    const $submenu = $header.parent().find('.menu-submenu');

                    if ($submenu.length > 0) {
                        $('.menu-submenu').not($submenu).removeClass('show');
                        $('.menu-group-header').not($header).removeClass('active');
                        $submenu.toggleClass('show');
                        $header.toggleClass('active');
                    } else {
                        // Link trực tiếp (Ví dụ Dashboard)
                        $('.menu-group-header').removeClass('active');
                        $('.submenu-item').removeClass('active');
                        $header.addClass('active');
                        showSection($header.data('section'));
                    }
                });

                // 3. Xử lý Click Submenu Item
                $('.submenu-item').click(function (e) {
                    // Chỉ xử lý UI Active state tại đây
                    const $item = $(this);
                    $('.submenu-item').removeClass('active');
                    $item.addClass('active');
                    $item.closest('.menu-group').find('.menu-group-header').addClass('active');

                    // Lấy URL từ data-url (nếu có)
                    const url = $item.attr('data-url');

                    // Nếu có data-url thì gọi AJAX (Menu Thuốc, Kho, Hóa đơn)
                    // Nếu KHÔNG có data-url (Menu Bệnh nhân dùng onclick="...") thì bỏ qua, để onclick tự chạy
                    if (url) {
                        e.preventDefault(); // Chặn link mặc định
                        if (url.includes('/NhanVien/')) loadEmployeeContent(url);
                        else if (url.includes('/HoaDon/')) loadInvoiceContent(url);
                        else if (url.includes('/Kho/')) loadWarehouseContent(url);
                        else loadThuocContent(url);
                    }
                });

                // 4. Đóng Panel khi nhấn ESC
                $(document).keydown(function (e) {
                    if (e.key === 'Escape' && panelStack.length > 0) {
                        closePanel(panelStack[panelStack.length - 1].level);
                    }
                });
            });
        </script>
}
