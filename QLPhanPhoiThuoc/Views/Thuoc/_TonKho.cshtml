@model IEnumerable<QLPhanPhoiThuoc.Models.Entities.LoThuoc>
@using System.Linq
@{
    var search = ViewBag.Search ?? "";
    var filter = ViewBag.Filter ?? "all";
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var totalItems = ViewBag.TotalItems ?? 0;
    var pageSize = ViewBag.PageSize ?? 20;
    var now = DateTime.Now;
}

<div class="tonkho-container">
    <!-- Header với thống kê nhanh -->
    <div class="tonkho-stats">
        <div class="stat-item stat-all">
            <div class="stat-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="stat-info">
                <h4>@totalItems</h4>
                <p>Tổng số lô</p>
            </div>
        </div>

        @{
            var expiringCount = Model?.Count(l => l.HanSuDung <= now.AddDays(30) && l.HanSuDung >= now && l.TrangThai == "ConHang") ?? 0;
            var expiredCount = Model?.Count(l => l.HanSuDung < now) ?? 0;
            var activeCount = Model?.Count(l => l.TrangThai == "ConHang") ?? 0;
        }

        <div class="stat-item stat-expiring">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h4>@expiringCount</h4>
                <p>Sắp hết hạn</p>
            </div>
        </div>

        <div class="stat-item stat-expired">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <h4>@expiredCount</h4>
                <p>Đã hết hạn</p>
            </div>
        </div>

        <div class="stat-item stat-active">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h4>@activeCount</h4>
                <p>Còn hàng</p>
            </div>
        </div>
    </div>

    <!-- Quick Filters -->
    <div class="quick-filters">
        <button type="button" class="filter-chip @(filter == "all" ? "active" : "")" onclick="setFilter('all')">
            <i class="fas fa-list"></i> Tất cả
            <span class="count">@totalItems</span>
        </button>
        <button type="button" class="filter-chip @(filter == "active" ? "active" : "")" onclick="setFilter('active')">
            <i class="fas fa-check-circle"></i> Còn hàng
            <span class="count">@activeCount</span>
        </button>
        <button type="button" class="filter-chip @(filter == "expiring" ? "active" : "")" onclick="setFilter('expiring')">
            <i class="fas fa-clock"></i> Sắp hết hạn
            <span class="count">@expiringCount</span>
        </button>
        <button type="button" class="filter-chip @(filter == "expired" ? "active" : "")" onclick="setFilter('expired')">
            <i class="fas fa-exclamation-triangle"></i> Đã hết hạn
            <span class="count">@expiredCount</span>
        </button>
    </div>

    <!-- Search & Filter Form -->
    <div class="filter-card">
        <form id="tonKhoFilterForm" method="get">
            <div class="filter-row">
                <div class="filter-group" style="flex: 3;">
                    <label><i class="fas fa-search"></i> Tìm kiếm</label>
                    <input type="text" name="search" value="@search" placeholder="Tên thuốc, mã lô, số lô..." />
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-filter"></i> Lọc theo</label>
                    <select name="filter">
                        <option value="all" selected="@(filter == "all")">Tất cả</option>
                        <option value="active" selected="@(filter == "active")">Còn hàng</option>
                        <option value="expiring" selected="@(filter == "expiring")">Sắp hết hạn (30 ngày)</option>
                        <option value="expired" selected="@(filter == "expired")">Đã hết hạn</option>
                    </select>
                </div>

                <div class="filter-group" style="min-width: auto;">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn-filter">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                </div>

                <div class="filter-group" style="min-width: auto;">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-reset" onclick="resetFilter()">
                        <i class="fas fa-redo"></i> Đặt lại
                    </button>
                </div>
            </div>

            <input type="hidden" name="page" value="@currentPage" />
        </form>
    </div>

    <!-- Result Info -->
    <div class="result-bar">
        <div class="result-info">
            <i class="fas fa-info-circle"></i>
            Hiển thị <strong>@Model.Count()</strong> / <strong>@totalItems</strong> lô thuốc
        </div>
    </div>

    <!-- Data Table -->
    <div class="tonkho-table-card">
        <div class="table-responsive">
            <table class="tonkho-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">Mã lô</th>
                        <th>Tên thuốc</th>
                        <th style="width: 120px;">Số lô</th>
                        <th style="width: 150px;">Kho</th>
                        <th style="width: 130px;">Hạn sử dụng</th>
                        <th style="width: 120px;">Còn lại</th>
                        <th style="width: 120px; text-align: center;">Số lượng</th>
                        <th style="width: 150px; text-align: center;">Trạng thái</th>
                        <th style="width: 100px; text-align: center;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var item in Model)
                        {
                            var daysUntilExpiry = (item.HanSuDung - now).Days;
                            var isExpired = item.HanSuDung < now;
                            var isExpiring = !isExpired && daysUntilExpiry <= 30;
                            var isNearExpiry = !isExpired && daysUntilExpiry <= 7;

                            var rowClass = isExpired ? "row-expired" : (isNearExpiry ? "row-critical" : (isExpiring ? "row-warning" : ""));
                            var statusClass = isExpired ? "status-expired" : (isNearExpiry ? "status-critical" : (isExpiring ? "status-warning" : "status-normal"));
                            var statusText = isExpired ? "Đã hết hạn" : (isNearExpiry ? "Rất gấp!" : (isExpiring ? "Sắp hết hạn" : "Bình thường"));
                            var statusIcon = isExpired ? "fa-times-circle" : (isNearExpiry ? "fa-exclamation-triangle" : (isExpiring ? "fa-clock" : "fa-check-circle"));

                            <tr class="@rowClass">
                                <td><strong>@item.MaLo</strong></td>
                                <td>
                                    <div class="medicine-name">@item.Thuoc.TenThuoc</div>
                                    <div class="medicine-code">@item.Thuoc.MaThuoc</div>
                                </td>
                                <td>
                                    <span class="lot-number">@item.SoLo</span>
                                </td>
                                <td>
                                    <i class="fas fa-warehouse"></i> @item.Kho.TenKho
                                </td>
                                <td>
                                    <div class="expiry-date">
                                        <i class="fas fa-calendar-alt"></i>
                                        @item.HanSuDung.ToString("dd/MM/yyyy")
                                    </div>
                                </td>
                                <td>
                                    @if (!isExpired)
                                    {
                                        if (daysUntilExpiry <= 7)
                                        {
                                            <span class="days-left critical">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                @daysUntilExpiry ngày
                                            </span>
                                        }
                                        else if (daysUntilExpiry <= 30)
                                        {
                                            <span class="days-left warning">
                                                <i class="fas fa-clock"></i>
                                                @daysUntilExpiry ngày
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="days-left normal">
                                                <i class="fas fa-check"></i>
                                                @daysUntilExpiry ngày
                                            </span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="days-left expired">
                                            <i class="fas fa-times"></i>
                                            Quá @Math.Abs(daysUntilExpiry) ngày
                                        </span>
                                    }
                                </td>
                                <td style="text-align: center;">
                                    <div class="quantity-display">
                                        <span class="quantity-number @(item.SoLuongCon == 0 ? "zero" : "")">
                                            @item.SoLuongCon
                                        </span>
                                        <div class="quantity-bar">
                                            @{
                                                var quantityPercent = item.SoLuongNhap > 0 ? (item.SoLuongCon * 100.0 / item.SoLuongNhap) : 0;
                                                var barClass = quantityPercent > 50 ? "bar-high" : (quantityPercent > 20 ? "bar-medium" : "bar-low");
                                            }
                                            <div class="quantity-bar-fill @barClass" style="width: @(quantityPercent)%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td style="text-align: center;">
                                    <span class="status-badge @statusClass">
                                        <i class="fas @statusIcon"></i>
                                        @statusText
                                    </span>
                                </td>
                                <td style="text-align: center;">
                                    <div class="action-buttons">
                                        <button class="btn-action btn-detail" onclick="viewLotDetail('@item.MaLo')" title="Xem chi tiết">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="empty-cell">
                                <div class="empty-state">
                                    <i class="fas fa-inbox"></i>
                                    <p>Không tìm thấy lô thuốc nào</p>
                                    <button class="btn-reset-filter" onclick="resetFilter()">
                                        <i class="fas fa-redo"></i> Đặt lại bộ lọc
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="pagination-container">
                <div class="pagination-info">
                    Trang @currentPage / @totalPages
                </div>
                <div class="pagination">
                    @if (currentPage > 1)
                    {
                        <a href="#" onclick="loadTonKhoPage(1); return false;">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                        <a href="#" onclick="loadTonKhoPage(@(currentPage - 1)); return false;">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    }

                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        if (i == currentPage)
                        {
                            <span class="active">@i</span>
                        }
                        else
                        {
                            <a href="#" onclick="loadTonKhoPage(@i); return false;">@i</a>
                        }
                    }

                    @if (currentPage < totalPages)
                    {
                        <a href="#" onclick="loadTonKhoPage(@(currentPage + 1)); return false;">
                            <i class="fas fa-angle-right"></i>
                        </a>
                        <a href="#" onclick="loadTonKhoPage(@totalPages); return false;">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    }
                </div>
            </div>
        }
    </div>
</div>

<style>
    /* ==================== TỒN KHO STYLES - ĐỒNG BỘ MÀU SẮC ==================== */
    
    .tonkho-container {
        animation: fadeIn 0.3s ease;
    }

    /* Stats Cards */
    .tonkho-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 25px;
    }

    .stat-item {
        background: white;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }

    .stat-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        transition: width 0.3s;
    }

    .stat-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-item:hover::before {
        width: 8px;
    }

    .stat-all::before { background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%); }
    .stat-expiring::before { background: linear-gradient(135deg, #f59e0b 0%, #f5576c 100%); }
    .stat-expired::before { background: linear-gradient(135deg, #fb7185 0%, #f43f5e 100%); }
    .stat-active::before { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .stat-all .stat-icon { background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%); }
    .stat-expiring .stat-icon { background: linear-gradient(135deg, #f59e0b 0%, #f5576c 100%); }
    .stat-expired .stat-icon { background: linear-gradient(135deg, #fb7185 0%, #f43f5e 100%); }
    .stat-active .stat-icon { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }

    .stat-info h4 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        color: #212529;
    }

    .stat-info p {
        margin: 5px 0 0 0;
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* Quick Filters */
    .quick-filters {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-chip {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 18px;
        border-radius: 20px;
        border: 2px solid #e9ecef;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        color: #495057;
    }

    .filter-chip:hover {
        border-color: #1e3a5f;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(30, 58, 95, 0.15);
    }

    .filter-chip.active {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        border-color: transparent;
        color: white;
    }

    .filter-chip .count {
        background: rgba(255, 255, 255, 0.2);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.85rem;
    }

    .filter-chip.active .count {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Result Bar */
    .result-bar {
        margin-bottom: 15px;
    }

    /* Table Card */
    .tonkho-table-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .tonkho-table {
        width: 100%;
        border-collapse: collapse;
    }

    .tonkho-table thead {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
    }

    .tonkho-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
        white-space: nowrap;
    }

    .tonkho-table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: background 0.2s;
    }

    .tonkho-table tbody tr:hover {
        background: #f8f9fa;
    }

    .tonkho-table tbody tr.row-warning {
        background: rgba(245, 158, 11, 0.05);
    }

    .tonkho-table tbody tr.row-critical {
        background: rgba(251, 113, 133, 0.08);
    }

    .tonkho-table tbody tr.row-expired {
        background: rgba(220, 53, 69, 0.1);
    }

    .tonkho-table td {
        padding: 14px 16px;
        font-size: 0.95rem;
    }

    /* Table Cell Content */
    .medicine-name {
        font-weight: 600;
        color: #212529;
    }

    .medicine-code {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 3px;
    }

    .lot-number {
        font-family: 'Courier New', monospace;
        background: #f8f9fa;
        padding: 4px 10px;
        border-radius: 6px;
        font-weight: 600;
        color: #1e3a5f;
        border: 1px solid #e9ecef;
    }

    .expiry-date {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        color: #495057;
    }

    /* Days Left Display */
    .days-left {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .days-left.normal {
        background: rgba(17, 153, 142, 0.15);
        color: #11998e;
        border: 1px solid rgba(17, 153, 142, 0.3);
    }

    .days-left.warning {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .days-left.critical {
        background: rgba(251, 113, 133, 0.15);
        color: #fb7185;
        border: 1px solid rgba(251, 113, 133, 0.3);
    }

    .days-left.expired {
        background: rgba(220, 53, 69, 0.15);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }

    /* Quantity Display */
    .quantity-display {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
    }

    .quantity-number {
        font-size: 1.3rem;
        font-weight: 700;
        color: #1e3a5f;
    }

    .quantity-number.zero {
        color: #dc3545;
    }

    .quantity-bar {
        width: 60px;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        position: relative;
    }

    .quantity-bar-fill {
        height: 100%;
        transition: width 0.5s ease;
        border-radius: 3px;
    }

    .quantity-bar-fill.bar-high {
        background: linear-gradient(90deg, #11998e, #38ef7d);
    }

    .quantity-bar-fill.bar-medium {
        background: linear-gradient(90deg, #f59e0b, #f5576c);
    }

    .quantity-bar-fill.bar-low {
        background: linear-gradient(90deg, #fb7185, #f43f5e);
    }

    /* Status Badge */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .status-badge.status-normal {
        background: rgba(17, 153, 142, 0.15);
        color: #11998e;
        border: 1px solid rgba(17, 153, 142, 0.3);
    }

    .status-badge.status-warning {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .status-badge.status-critical {
        background: rgba(251, 113, 133, 0.15);
        color: #fb7185;
        border: 1px solid rgba(251, 113, 133, 0.3);
    }

    .status-badge.status-expired {
        background: #dc3545;
        color: white;
        border: none;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 5px;
        justify-content: center;
    }

    .btn-action {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        font-size: 0.9rem;
    }

    .btn-detail {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
    }

    .btn-detail:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(30, 58, 95, 0.3);
    }

    /* Empty State */
    .empty-cell {
        padding: 0 !important;
    }

    .empty-state {
        padding: 60px 20px;
        text-align: center;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 15px;
    }

    .empty-state p {
        margin: 0 0 15px 0;
        font-size: 1.1rem;
    }

    .btn-reset-filter {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-reset-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
    }

    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
    }

    .pagination-info {
        color: #6c757d;
        font-size: 0.95rem;
    }

    .pagination {
        display: flex;
        gap: 5px;
    }

    .pagination a,
    .pagination span {
        min-width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        color: #495057;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
        border: 1px solid #dee2e6;
        background: white;
    }

    .pagination a:hover {
        background: #1e3a5f;
        color: white;
        border-color: #1e3a5f;
        transform: translateY(-2px);
    }

    .pagination span.active {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
        border-color: transparent;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .tonkho-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .quick-filters {
            flex-direction: column;
        }

        .filter-chip {
            width: 100%;
            justify-content: center;
        }

        .filter-row {
            flex-direction: column;
        }

        .filter-group {
            width: 100%;
        }

        .table-responsive {
            overflow-x: auto;
        }
    }
</style>

<script>
    // ===== FUNCTIONS FOR TON KHO MANAGEMENT =====

    // Set filter and reload
    function setFilter(filterValue) {
        const form = document.getElementById('tonKhoFilterForm');
        const filterInput = form.querySelector('select[name="filter"]');
        filterInput.value = filterValue;
        
        const formData = new FormData(form);
        formData.set('page', 1); // Reset to first page
        
        const params = new URLSearchParams(formData);
        loadThuocContent('/Admin/Thuoc/LoThuoc?' + params.toString());
    }

    // Load specific page
    function loadTonKhoPage(pageNum) {
        const form = document.getElementById('tonKhoFilterForm');
        const formData = new FormData(form);
        formData.set('page', pageNum);
        
        const params = new URLSearchParams(formData);
        loadThuocContent('/Admin/Thuoc/LoThuoc?' + params.toString());
    }

    // Reset filter
    function resetFilter() {
        document.querySelector('input[name="search"]').value = '';
        document.querySelector('select[name="filter"]').value = 'all';
        
        loadThuocContent('/Admin/Thuoc/LoThuoc?filter=all&page=1');
    }

    // View lot detail
    function viewLotDetail(maLo) {
        // Implement detail view - có thể mở modal hoặc navigate
        alert('Chi tiết lô thuốc: ' + maLo);
        // window.location.href = '/Admin/Thuoc/LoThuocDetail/' + maLo;
    }

    // Form submit handler
    document.getElementById('tonKhoFilterForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.set('page', 1); // Reset to first page on new search
        
        const params = new URLSearchParams(formData);
        loadThuocContent('/Admin/Thuoc/LoThuoc?' + params.toString());
    });
</script>
