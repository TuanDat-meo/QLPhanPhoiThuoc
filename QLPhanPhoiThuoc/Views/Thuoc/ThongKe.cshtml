@{
    ViewData["Title"] = "Thống kê sử dụng thuốc";
    var tuNgay = ViewBag.TuNgay ?? DateTime.Now.AddMonths(-1);
    var denNgay = ViewBag.DenNgay ?? DateTime.Now;
    var topThuocBanChay = ViewBag.TopThuocBanChay as dynamic ?? new List<dynamic>();
    var thongKeNhom = ViewBag.ThongKeNhom as dynamic ?? new List<dynamic>();
}

<style>
    .stats-container {
        padding: 25px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 25px 30px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
    }

    .date-filter-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .date-filter-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
    }

    .date-group {
        flex: 1;
        min-width: 200px;
    }

    .date-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
    }

    .date-group input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.95rem;
    }

    .btn-apply {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-apply:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 25px;
    }

    .chart-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .chart-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .chart-card-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        color: white;
    }

    .chart-card-icon.blue {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .chart-card-icon.purple {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .chart-card-icon.green {
        background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
    }

    .chart-card-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1e3a5f;
        margin: 0;
    }

    .chart-wrapper {
        position: relative;
        height: 350px;
    }

    .top-medicines-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .medicine-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        margin-bottom: 12px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid;
        transition: all 0.3s;
    }

    .medicine-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }

    .medicine-item:nth-child(1) { border-color: #ffd700; }
    .medicine-item:nth-child(2) { border-color: #c0c0c0; }
    .medicine-item:nth-child(3) { border-color: #cd7f32; }
    .medicine-item:nth-child(n+4) { border-color: #4facfe; }

    .medicine-info {
        flex: 1;
    }

    .medicine-rank {
        font-size: 1.5rem;
        font-weight: 700;
        color: #dee2e6;
        margin-right: 15px;
        min-width: 30px;
    }

    .medicine-name {
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 3px;
    }

    .medicine-quantity {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .medicine-value {
        text-align: right;
    }

    .medicine-amount {
        font-size: 1.3rem;
        font-weight: 700;
        color: #28a745;
    }

    .medicine-unit {
        font-size: 0.85rem;
        color: #6c757d;
        display: block;
    }

    .group-stats-table {
        width: 100%;
        border-collapse: collapse;
    }

    .group-stats-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .group-stats-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }

    .group-stats-table td {
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
    }

    .group-stats-table tbody tr:hover {
        background: #f8f9fa;
    }

    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        transition: width 0.5s;
    }

    .export-btn {
        background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        margin-bottom: 20px;
    }

    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(56, 239, 125, 0.4);
        color: white;
        text-decoration: none;
    }
</style>

<div class="stats-container">
    <!-- Page Header -->
    <div class="page-header">
        <h2><i class="fas fa-chart-bar"></i> Thống kê sử dụng thuốc</h2>
        <p>Phân tích xu hướng và báo cáo sử dụng thuốc</p>
    </div>

    <!-- Date Filter -->
    <div class="date-filter-card">
        <form method="get" asp-action="ThongKe">
            <div class="date-filter-row">
                <div class="date-group">
                    <label><i class="fas fa-calendar-alt"></i> Từ ngày</label>
                    <input type="date" name="tuNgay" value="@tuNgay.ToString("yyyy-MM-dd")" />
                </div>

                <div class="date-group">
                    <label><i class="fas fa-calendar-alt"></i> Đến ngày</label>
                    <input type="date" name="denNgay" value="@denNgay.ToString("yyyy-MM-dd")" />
                </div>

                <div class="date-group" style="min-width: auto;">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn-apply">
                        <i class="fas fa-search"></i> Xem thống kê
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Export Button -->
    <a href="@Url.Action("ExportThongKe", new { tuNgay = tuNgay.ToString("yyyy-MM-dd"), denNgay = denNgay.ToString("yyyy-MM-dd") })" 
       class="export-btn">
        <i class="fas fa-file-excel"></i> Xuất báo cáo Excel
    </a>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <!-- Top 10 Medicines Chart -->
        <div class="chart-card" style="grid-column: span 2;">
            <div class="chart-card-header">
                <div class="chart-card-icon blue">
                    <i class="fas fa-trophy"></i>
                </div>
                <h3 class="chart-card-title">Top 10 thuốc được sử dụng nhiều nhất</h3>
            </div>
            
            @if (topThuocBanChay.Count > 0)
            {
                <ul class="top-medicines-list">
                    @for (int i = 0; i < Math.Min(10, topThuocBanChay.Count); i++)
                    {
                        var item = topThuocBanChay[i];
                        var tenThuoc = item.GetType().GetProperty("TenThuoc")?.GetValue(item)?.ToString() ?? "";
                        var soLuong = Convert.ToInt32(item.GetType().GetProperty("SoLuong")?.GetValue(item) ?? 0);
                        var doanhThu = Convert.ToDecimal(item.GetType().GetProperty("DoanhThu")?.GetValue(item) ?? 0);
                        
                        <li class="medicine-item">
                            <span class="medicine-rank">#@(i + 1)</span>
                            <div class="medicine-info">
                                <div class="medicine-name">@tenThuoc</div>
                                <div class="medicine-quantity">
                                    <i class="fas fa-box"></i> @soLuong.ToString("N0") đơn vị
                                </div>
                            </div>
                            <div class="medicine-value">
                                <div class="medicine-amount">@((doanhThu / 1000000).ToString("N2"))M</div>
                                <span class="medicine-unit">VNĐ</span>
                            </div>
                        </li>
                    }
                </ul>
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <p>Chưa có dữ liệu trong khoảng thời gian này</p>
                </div>
            }
        </div>

        <!-- Medicine Groups Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-card-icon purple">
                    <i class="fas fa-layer-group"></i>
                </div>
                <h3 class="chart-card-title">Thống kê theo nhóm thuốc</h3>
            </div>
            
            @if (thongKeNhom.Count > 0)
            {
                <div class="table-responsive">
                    <table class="group-stats-table">
                        <thead>
                            <tr>
                                <th>Nhóm thuốc</th>
                                <th style="text-align: right;">Số lượng</th>
                                <th style="text-align: right;">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                decimal maxRevenue = 0;
                                foreach (var n in thongKeNhom)
                                {
                                    var dt = Convert.ToDecimal(n.GetType().GetProperty("DoanhThu")?.GetValue(n) ?? 0);
                                    if (dt > maxRevenue) maxRevenue = dt;
                                }
                            }
                            @foreach (var nhom in thongKeNhom)
                            {
                                var nhomThuoc = nhom.GetType().GetProperty("NhomThuoc")?.GetValue(nhom)?.ToString() ?? "Chưa phân loại";
                                var soLuong = Convert.ToInt32(nhom.GetType().GetProperty("SoLuong")?.GetValue(nhom) ?? 0);
                                var doanhThu = Convert.ToDecimal(nhom.GetType().GetProperty("DoanhThu")?.GetValue(nhom) ?? 0);
                                var percent = maxRevenue > 0 ? (doanhThu / maxRevenue * 100) : 0;
                                
                                <tr>
                                    <td>
                                        <strong>@nhomThuoc</strong>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" style="width: @percent%"></div>
                                        </div>
                                    </td>
                                    <td style="text-align: right;">
                                        <strong>@soLuong.ToString("N0")</strong>
                                    </td>
                                    <td style="text-align: right;">
                                        <strong style="color: #28a745;">@((doanhThu / 1000000).ToString("N2"))M</strong>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-layer-group"></i>
                    <p>Chưa có dữ liệu theo nhóm</p>
                </div>
            }
        </div>

        <!-- Revenue Chart -->
        <div class="chart-card">
            <div class="chart-card-header">
                <div class="chart-card-icon green">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <h3 class="chart-card-title">Biểu đồ doanh thu</h3>
            </div>
            <div class="chart-wrapper">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(document).ready(function() {
            // Prepare data for revenue chart
            var topThuocs = @Html.Raw(Json.Serialize(topThuocBanChay));
            var labels = [];
            var data = [];
            
            for (var i = 0; i < Math.min(5, topThuocs.length); i++) {
                labels.push(topThuocs[i].tenThuoc);
                data.push(topThuocs[i].doanhThu / 1000000);
            }

            // Revenue Chart
            const ctx = document.getElementById('revenueChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Doanh thu (triệu VNĐ)',
                            data: data,
                            backgroundColor: [
                                'rgba(56, 239, 125, 0.8)',
                                'rgba(17, 153, 142, 0.8)',
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(79, 172, 254, 0.8)'
                            ],
                            borderColor: [
                                'rgba(56, 239, 125, 1)',
                                'rgba(17, 153, 142, 1)',
                                'rgba(102, 126, 234, 1)',
                                'rgba(118, 75, 162, 1)',
                                'rgba(79, 172, 254, 1)'
                            ],
                            borderWidth: 2,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(30, 58, 95, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#1e3a5f',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: false,
                                callbacks: {
                                    label: function(context) {
                                        return 'Doanh thu: ' + context.parsed.y.toFixed(2) + ' triệu VNĐ';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(1) + 'M';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
}
