@{
    var tuNgay = ViewBag.TuNgay as DateTime? ?? DateTime.Now.AddMonths(-1);
    var denNgay = ViewBag.DenNgay as DateTime? ?? DateTime.Now;
    var topThuocBanChay = ViewBag.TopThuocBanChay as List<dynamic> ?? new List<dynamic>();
    var thongKeNhom = ViewBag.ThongKeNhom as List<dynamic> ?? new List<dynamic>();
}

<div class="statistics-container">
    <!-- Bộ lọc thời gian -->
    <div class="filter-card">
        <form id="statisticsFilterForm" method="get">
            <div class="filter-row">
                <div class="filter-group">
                    <label><i class="fas fa-calendar-alt"></i> Từ ngày</label>
                    <input type="date" name="tuNgay" value="@tuNgay.ToString("yyyy-MM-dd")" required />
                </div>

                <div class="filter-group">
                    <label><i class="fas fa-calendar-check"></i> Đến ngày</label>
                    <input type="date" name="denNgay" value="@denNgay.ToString("yyyy-MM-dd")" required />
                </div>

                <div class="filter-group" style="min-width: auto;">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn-filter">
                        <i class="fas fa-chart-line"></i> Xem thống kê
                    </button>
                </div>

                <div class="filter-group" style="min-width: auto;">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-preset" onclick="setPresetRange('week')">
                        <i class="fas fa-calendar-week"></i> 7 ngày
                    </button>
                </div>

                <div class="filter-group" style="min-width: auto;">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-preset" onclick="setPresetRange('month')">
                        <i class="fas fa-calendar"></i> 30 ngày
                    </button>
                </div>

                <div class="filter-group" style="min-width: auto;">
                    <label>&nbsp;</label>
                    <button type="button" class="btn-preset" onclick="setPresetRange('quarter')">
                        <i class="fas fa-calendar-alt"></i> 3 tháng
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Thông tin thời gian -->
    <div class="period-info">
        <i class="fas fa-info-circle"></i>
        <strong>Thống kê từ:</strong> @tuNgay.ToString("dd/MM/yyyy") - @denNgay.ToString("dd/MM/yyyy")
        <span class="period-days">(@((denNgay - tuNgay).Days + 1) ngày)</span>
    </div>

    <!-- Top 10 thuốc bán chạy -->
    <div class="statistics-section">
        <div class="section-header">
            <div class="header-left">
                <i class="fas fa-trophy"></i>
                <h3>Top 10 Thuốc Bán Chạy Nhất</h3>
            </div>
            <span class="badge badge-primary">@topThuocBanChay.Count thuốc</span>
        </div>

        @if (topThuocBanChay.Any())
        {
            <div class="chart-container">
                <canvas id="topMedicinesChart"></canvas>
            </div>

            <div class="table-responsive">
                <table class="statistics-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">Hạng</th>
                            <th>Mã thuốc</th>
                            <th>Tên thuốc</th>
                            <th style="text-align: right;">Số lượng bán</th>
                            <th style="text-align: right;">Doanh thu</th>
                            <th style="width: 200px;">Tỷ lệ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var maxSoLuong = topThuocBanChay.FirstOrDefault()?.SoLuong ?? 1;
                            var rank = 1;
                        }
                        @foreach (var item in topThuocBanChay)
                        {
                            var percentage = (double)item.SoLuong / maxSoLuong * 100;
                            var rankClass = rank == 1 ? "rank-gold" : (rank == 2 ? "rank-silver" : (rank == 3 ? "rank-bronze" : "rank-normal"));

                            <tr>
                                <td>
                                    <div class="rank-badge @rankClass">
                                        @if (rank <= 3)
                                        {
                                            <i class="fas fa-medal"></i>
                                        }
                                        #@rank
                                    </div>
                                </td>
                                <td><strong>@item.MaThuoc</strong></td>
                                <td>@item.TenThuoc</td>
                                <td style="text-align: right;">
                                    <span class="quantity-highlight">@item.SoLuong.ToString("N0")</span>
                                </td>
                                <td style="text-align: right;">
                                    <span class="revenue-highlight">@item.DoanhThu.ToString("N0") ₫</span>
                                </td>
                                <td>
                                    <div class="progress-container">
                                        <div class="progress-bar" style="width: @percentage.ToString("0.0")%"></div>
                                        <span class="progress-text">@percentage.ToString("0.0")%</span>
                                    </div>
                                </td>
                            </tr>
                            rank++;
                        }
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3"><strong>TỔNG CỘNG</strong></td>
                            <td style="text-align: right;">
                                <strong class="total-quantity">@topThuocBanChay.Sum(x => x.SoLuong).ToString("N0")</strong>
                            </td>
                            <td style="text-align: right;">
                                <strong class="total-revenue">@topThuocBanChay.Sum(x => x.DoanhThu).ToString("N0") ₫</strong>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }
        else
        {
            <div class="empty-state">
                <i class="fas fa-chart-line"></i>
                <p>Chưa có dữ liệu bán hàng trong khoảng thời gian này</p>
            </div>
        }
    </div>

    <!-- Thống kê theo nhóm thuốc -->
    <div class="statistics-section">
        <div class="section-header">
            <div class="header-left">
                <i class="fas fa-layer-group"></i>
                <h3>Thống Kê Theo Nhóm Thuốc</h3>
            </div>
            <span class="badge badge-success">@thongKeNhom.Count nhóm</span>
        </div>

        @if (thongKeNhom.Any())
        {
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>

            <div class="table-responsive">
                <table class="statistics-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">STT</th>
                            <th>Nhóm thuốc</th>
                            <th style="text-align: right;">Số lượng bán</th>
                            <th style="text-align: right;">Doanh thu</th>
                            <th style="text-align: right;">% Doanh thu</th>
                            <th style="width: 200px;">Biểu đồ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var totalRevenue = thongKeNhom.Sum(x => x.DoanhThu);
                            var stt = 1;
                        }
                        @foreach (var item in thongKeNhom)
                        {
                            var revenuePercentage = totalRevenue > 0 ? (double)item.DoanhThu / totalRevenue * 100 : 0;
                            var categoryColors = new[] { "#4e73df", "#1cc88a", "#36b9cc", "#f6c23e", "#e74a3b", "#858796", "#5a5c69" };
                            var colorIndex = (stt - 1) % categoryColors.Length;

                            <tr>
                                <td>
                                    <div class="category-marker" style="background: @categoryColors[colorIndex]">
                                        @stt
                                    </div>
                                </td>
                                <td>
                                    <strong>@(item.NhomThuoc ?? "Chưa phân loại")</strong>
                                </td>
                                <td style="text-align: right;">
                                    <span class="quantity-highlight">@item.SoLuong.ToString("N0")</span>
                                </td>
                                <td style="text-align: right;">
                                    <span class="revenue-highlight">@item.DoanhThu.ToString("N0") ₫</span>
                                </td>
                                <td style="text-align: right;">
                                    <strong class="percentage-text">@revenuePercentage.ToString("0.00")%</strong>
                                </td>
                                <td>
                                    <div class="progress-container">
                                        <div class="progress-bar" style="width: @revenuePercentage.ToString("0.0")%; background: @categoryColors[colorIndex]"></div>
                                        <span class="progress-text">@revenuePercentage.ToString("0.0")%</span>
                                    </div>
                                </td>
                            </tr>
                            stt++;
                        }
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="2"><strong>TỔNG CỘNG</strong></td>
                            <td style="text-align: right;">
                                <strong class="total-quantity">@thongKeNhom.Sum(x => x.SoLuong).ToString("N0")</strong>
                            </td>
                            <td style="text-align: right;">
                                <strong class="total-revenue">@totalRevenue.ToString("N0") ₫</strong>
                            </td>
                            <td style="text-align: right;">
                                <strong class="percentage-text">100%</strong>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }
        else
        {
            <div class="empty-state">
                <i class="fas fa-layer-group"></i>
                <p>Chưa có dữ liệu phân loại nhóm thuốc</p>
            </div>
        }
    </div>
</div>

<style>
    .statistics-container {
        padding: 20px 0;
    }

    .filter-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }

    .filter-group {
        flex: 1;
        min-width: 150px;
    }

    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }

    .filter-group input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: all 0.3s;
    }

    .filter-group input:focus {
        border-color: #1e3a5f;
        box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        outline: none;
    }

    .btn-filter, .btn-preset {
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }

    .btn-filter {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
    }

    .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
    }

    .btn-preset {
        background: #f8f9fa;
        color: #495057;
        border: 1px solid #dee2e6;
    }

    .btn-preset:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }

    .period-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .period-info i {
        font-size: 1.2rem;
    }

    .period-days {
        margin-left: 10px;
        opacity: 0.9;
        font-weight: 600;
    }

    .statistics-section {
        background: white;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .section-header {
        background: linear-gradient(135deg, #1e3a5f 0%, #0f2847 100%);
        color: white;
        padding: 20px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-left i {
        font-size: 1.5rem;
    }

    .header-left h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        background: rgba(255, 255, 255, 0.3);
    }

    .chart-container {
        padding: 30px;
        background: #f8f9fa;
    }

    .chart-container canvas {
        max-height: 400px;
    }

    .statistics-table {
        width: 100%;
        border-collapse: collapse;
    }

    .statistics-table thead th {
        padding: 15px;
        background: #f8f9fa;
        font-weight: 600;
        text-align: left;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        font-size: 0.9rem;
    }

    .statistics-table tbody td {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: middle;
    }

    .statistics-table tbody tr:hover {
        background: #f8f9fa;
    }

    .statistics-table tfoot {
        background: #f8f9fa;
        font-weight: 700;
    }

    .statistics-table tfoot td {
        padding: 15px;
        border-top: 3px double #dee2e6;
    }

    .rank-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        padding: 8px 12px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .rank-gold {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: #333;
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
    }

    .rank-silver {
        background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
        color: #333;
        box-shadow: 0 2px 8px rgba(192, 192, 192, 0.4);
    }

    .rank-bronze {
        background: linear-gradient(135deg, #CD7F32, #B87333);
        color: white;
        box-shadow: 0 2px 8px rgba(205, 127, 50, 0.4);
    }

    .rank-normal {
        background: #6c757d;
        color: white;
    }

    .quantity-highlight {
        color: #1e3a5f;
        font-weight: 700;
        font-size: 1.05rem;
    }

    .revenue-highlight {
        color: #28a745;
        font-weight: 700;
        font-size: 1.05rem;
    }

    .progress-container {
        position: relative;
        background: #e9ecef;
        border-radius: 10px;
        height: 28px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        transition: width 0.8s ease-in-out;
        border-radius: 10px;
    }

    .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: 600;
        font-size: 0.85rem;
        color: #495057;
    }

    .category-marker {
        width: 35px;
        height: 35px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        margin: 0 auto;
    }

    .percentage-text {
        color: #667eea;
        font-size: 1.05rem;
    }

    .total-row {
        background: #f8f9fa;
    }

    .total-quantity {
        color: #1e3a5f;
        font-size: 1.1rem;
    }

    .total-revenue {
        color: #28a745;
        font-size: 1.1rem;
    }

    .empty-state {
        padding: 80px 20px;
        text-align: center;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 5rem;
        color: #dee2e6;
        margin-bottom: 20px;
    }

    .empty-state p {
        margin: 0;
        font-size: 1.1rem;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Preset date ranges
    function setPresetRange(range) {
        const denNgay = new Date();
        let tuNgay = new Date();

        switch(range) {
            case 'week':
                tuNgay.setDate(denNgay.getDate() - 7);
                break;
            case 'month':
                tuNgay.setDate(denNgay.getDate() - 30);
                break;
            case 'quarter':
                tuNgay.setMonth(denNgay.getMonth() - 3);
                break;
        }

        document.querySelector('input[name="tuNgay"]').value = tuNgay.toISOString().split('T')[0];
        document.querySelector('input[name="denNgay"]').value = denNgay.toISOString().split('T')[0];
        
        document.getElementById('statisticsFilterForm').submit();
    }

    // Top Medicines Chart
    @if (topThuocBanChay.Any())
    {
        <text>
        const topMedicinesCtx = document.getElementById('topMedicinesChart').getContext('2d');
        new Chart(topMedicinesCtx, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(string.Join(",", topThuocBanChay.Select(x => $"'{x.TenThuoc}'")))],
                datasets: [{
                    label: 'Số lượng bán',
                    data: [@Html.Raw(string.Join(",", topThuocBanChay.Select(x => x.SoLuong)))],
                    backgroundColor: 'rgba(30, 58, 95, 0.8)',
                    borderColor: 'rgba(30, 58, 95, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Biểu đồ số lượng bán',
                        font: { size: 16, weight: 'bold' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        </text>
    }

    // Category Chart
    @if (thongKeNhom.Any())
    {
        <text>
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: [@Html.Raw(string.Join(",", thongKeNhom.Select(x => $"'{x.NhomThuoc ?? "Chưa phân loại"}'")))],
                datasets: [{
                    data: [@Html.Raw(string.Join(",", thongKeNhom.Select(x => x.DoanhThu)))],
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', 
                        '#e74a3b', '#858796', '#5a5c69', '#2e59d9'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Phân bố doanh thu theo nhóm thuốc',
                        font: { size: 16, weight: 'bold' }
                    }
                }
            }
        });
        </text>
    }
</script>
