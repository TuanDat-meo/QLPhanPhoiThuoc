@model IEnumerable<dynamic>
@using System.Linq
@{
    ViewData["Title"] = "Quản lý tồn kho";
    var search = ViewBag.Search ?? "";
    var filter = ViewBag.Filter ?? "all";
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var totalItems = ViewBag.TotalItems ?? 0;
}

<style>
    .stock-container {
        padding: 25px;
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px 30px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .quick-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-chip {
        padding: 10px 20px;
        border-radius: 25px;
        border: 2px solid #dee2e6;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        color: #6c757d;
    }

    .filter-chip:hover {
        border-color: #667eea;
        color: #667eea;
        transform: translateY(-2px);
    }

    .filter-chip.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }

    .stock-table-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stock-table {
        width: 100%;
        margin: 0;
    }

    .stock-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .stock-table thead th {
        padding: 15px;
        font-weight: 600;
        text-align: left;
        border: none;
    }

    .stock-table tbody tr {
        border-bottom: 1px solid #e9ecef;
        transition: all 0.2s;
    }

    .stock-table tbody tr:hover {
        background: #f8f9fa;
    }

    .stock-table tbody td {
        padding: 15px;
        vertical-align: middle;
    }

    .stock-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .stock-normal {
        background: #d4edda;
        color: #155724;
    }

    .stock-low {
        background: #fff3cd;
        color: #856404;
    }

    .stock-out {
        background: #f8d7da;
        color: #721c24;
    }

    .stock-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }

    .stock-bar-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s;
    }

    .stock-bar-fill.normal {
        background: linear-gradient(90deg, #38ef7d 0%, #11998e 100%);
    }

    .stock-bar-fill.low {
        background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    }

    .stock-bar-fill.out {
        background: #dc3545;
    }

    .btn-restock {
        background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-restock:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(56, 239, 125, 0.4);
    }
</style>

<div class="stock-container">
    <!-- Page Header -->
    <div class="page-header">
        <h2><i class="fas fa-boxes"></i> Quản lý tồn kho thuốc</h2>
        <p>Theo dõi và cập nhật tình trạng tồn kho</p>
    </div>

    <!-- Quick Filters -->
    <div class="quick-filters">
        <a href="?filter=all" class="filter-chip @(filter == "all" ? "active" : "")">
            <i class="fas fa-list"></i> Tất cả (@totalItems)
        </a>
        <a href="?filter=low" class="filter-chip @(filter == "low" ? "active" : "")">
            <i class="fas fa-exclamation-triangle"></i> Sắp hết
        </a>
        <a href="?filter=out" class="filter-chip @(filter == "out" ? "active" : "")">
            <i class="fas fa-times-circle"></i> Hết hàng
        </a>
    </div>

    <!-- Search Bar -->
    <div class="filter-card">
        <form method="get" asp-action="TonKho">
            <div class="filter-row">
                <div class="filter-group" style="flex: 2;">
                    <label><i class="fas fa-search"></i> Tìm kiếm thuốc</label>
                    <input type="text" name="search" value="@search" placeholder="Nhập tên hoặc mã thuốc..." />
                </div>
                <div class="filter-group" style="min-width: auto;">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn-filter">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                </div>
            </div>
            <input type="hidden" name="filter" value="@filter" />
        </form>
    </div>

    <!-- Stock Table -->
    <div class="stock-table-card">
        <div class="table-responsive">
            <table class="stock-table">
                <thead>
                    <tr>
                        <th>Mã thuốc</th>
                        <th>Tên thuốc</th>
                        <th>Đơn vị</th>
                        <th>Tồn kho</th>
                        <th>Tồn tối thiểu</th>
                        <th>Trạng thái</th>
                        <th>Tiến độ</th>
                        <th style="text-align: center;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            var thuoc = item.Thuoc;
                            var tonKho = item.TonKho;
                            var tonToiThieu = thuoc.TonKhoToiThieu > 0 ? thuoc.TonKhoToiThieu : 10;
                            var percent = tonToiThieu > 0 ? (tonKho * 100.0 / tonToiThieu) : 100;
                            var statusClass = tonKho == 0 ? "out" : (tonKho <= tonToiThieu ? "low" : "normal");
                            
                            <tr>
                                <td><strong>@thuoc.MaThuoc</strong></td>
                                <td>@thuoc.TenThuoc</td>
                                <td>@thuoc.DonViTinh</td>
                                <td>
                                    <strong style="font-size: 1.1rem; color: @(statusClass == "normal" ? "#28a745" : statusClass == "low" ? "#ffc107" : "#dc3545")">
                                        @tonKho
                                    </strong>
                                </td>
                                <td>@tonToiThieu</td>
                                <td>
                                    @if (tonKho == 0)
                                    {
                                        <span class="stock-status stock-out">
                                            <i class="fas fa-times-circle"></i> Hết hàng
                                        </span>
                                    }
                                    else if (tonKho <= tonToiThieu)
                                    {
                                        <span class="stock-status stock-low">
                                            <i class="fas fa-exclamation-triangle"></i> Sắp hết
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="stock-status stock-normal">
                                            <i class="fas fa-check-circle"></i> Bình thường
                                        </span>
                                    }
                                </td>
                                <td style="width: 150px;">
                                    <div class="stock-bar">
                                        <div class="stock-bar-fill @statusClass" style="width: @Math.Min(percent, 100)%"></div>
                                    </div>
                                    <small style="color: #6c757d;">@percent.ToString("N0")%</small>
                                </td>
                                <td style="text-align: center;">
                                    <a href="@Url.Action("Details", "Thuoc", new { id = thuoc.MaThuoc })" class="btn-action btn-view" title="Chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="@Url.Action("Create", "PhieuNhap", new { maThuoc = thuoc.MaThuoc })" class="btn-restock" title="Nhập thêm">
                                        <i class="fas fa-plus"></i> Nhập
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 50px;">
                                <i class="fas fa-inbox" style="font-size: 3rem; color: #dee2e6; margin-bottom: 15px;"></i>
                                <p style="color: #6c757d; margin: 0;">Không tìm thấy thuốc nào</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="pagination-container">
                <div class="pagination-info">
                    Trang @currentPage / @totalPages
                </div>
                <div class="pagination">
                    @if (currentPage > 1)
                    {
                        <a href="?page=1&search=@search&filter=@filter"><i class="fas fa-angle-double-left"></i></a>
                        <a href="?page=@(currentPage - 1)&search=@search&filter=@filter"><i class="fas fa-angle-left"></i></a>
                    }

                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        if (i == currentPage)
                        {
                            <span class="active">@i</span>
                        }
                        else
                        {
                            <a href="?page=@i&search=@search&filter=@filter">@i</a>
                        }
                    }

                    @if (currentPage < totalPages)
                    {
                        <a href="?page=@(currentPage + 1)&search=@search&filter=@filter"><i class="fas fa-angle-right"></i></a>
                        <a href="?page=@totalPages&search=@search&filter=@filter"><i class="fas fa-angle-double-right"></i></a>
                    }
                </div>
            </div>
        }
    </div>
</div>
