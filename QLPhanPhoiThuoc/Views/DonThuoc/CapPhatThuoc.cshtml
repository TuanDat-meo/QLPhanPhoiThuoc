@{
    var chucVu = ViewBag.ChucVu ?? "Dược sĩ";
    var maNhanVien = ViewBag.MaNhanVien ?? "";
    var donChoCapPhat = ViewBag.DonChoCapPhat ?? 0;
    var donDaCapPhat = ViewBag.DonDaCapPhat ?? 0;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cấp Phát Thuốc</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        color: #333;
    }

    .dispensing-container {
        padding: 25px;
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Page Header */
    .page-header {
        background: linear-gradient(135deg, #00796b 0%, #00897b 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .page-header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .page-header p {
        opacity: 0.9;
        font-size: 1rem;
    }

    /* Quick Stats */
    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .quick-stat {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
    }

    .quick-stat:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .quick-stat-icon {
        width: 70px;
        height: 70px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        color: white;
    }

    .quick-stat-icon.warning {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    }

    .quick-stat-icon.success {
        background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    }

    .quick-stat-info h3 {
        font-size: 2rem;
        font-weight: 700;
        color: #1e3a5f;
        margin: 0;
    }

    .quick-stat-info p {
        margin: 0;
        color: #666;
        font-size: 0.95rem;
    }

    /* Tabs */
    .dispensing-tabs {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        border-bottom: 3px solid #e0e0e0;
    }

    .tab-button {
        padding: 14px 28px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        color: #666;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        margin-bottom: -3px;
    }

    .tab-button:hover {
        color: #00796b;
    }

    .tab-button.active {
        color: #00796b;
        border-bottom-color: #00796b;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Queue Card */
    .queue-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }

    .queue-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }

    .queue-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1e3a5f;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    /* Queue Item */
    .queue-item {
        background: linear-gradient(to right, #fff9e6 0%, white 100%);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 5px solid #ff9800;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .queue-item:hover {
        transform: translateX(8px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        background: white;
    }

    .queue-item-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
    }

    .queue-item-info h4 {
        font-size: 1.15rem;
        font-weight: 600;
        color: #1e3a5f;
        margin: 0 0 5px 0;
    }

    .queue-item-info p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }

    .queue-item-badge {
        padding: 7px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .badge-urgent {
        background: linear-gradient(135deg, #ff5252, #f44336);
        color: white;
        animation: pulse 2s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    .badge-normal {
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
    }

    .queue-item-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .detail-box {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(0,121,107,0.05);
        padding: 10px;
        border-radius: 8px;
    }

    .detail-box i {
        color: #00796b;
        font-size: 1.2rem;
    }

    .detail-label {
        font-size: 0.75rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
    }

    .detail-value {
        font-size: 1rem;
        color: #1e3a5f;
        font-weight: 600;
    }

    .queue-item-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Buttons */
    .btn {
        padding: 11px 22px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: linear-gradient(135deg, #00796b 0%, #00897b 100%);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 121, 107, 0.3);
    }

    .btn-success {
        background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
        color: white;
    }

    .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-sm {
        padding: 7px 14px;
        font-size: 0.85rem;
    }

    /* Dispensing Modal */
    .dispensing-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(4px);
    }

    .dispensing-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .modal-content-large {
        background: white;
        border-radius: 15px;
        width: 96%;
        max-width: 1400px;
        max-height: 92vh;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        background: linear-gradient(135deg, #00796b 0%, #00897b 100%);
        color: white;
        padding: 20px 25px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .close-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        color: white;
        font-size: 1.3rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .close-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: rotate(90deg);
    }

    .modal-split {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 0;
        flex: 1;
        overflow: hidden;
    }

    .modal-left {
        padding: 25px;
        overflow-y: auto;
        background: #fafafa;
    }

    .modal-right {
        background: white;
        padding: 25px;
        border-left: 2px solid #e0e0e0;
        overflow-y: auto;
    }

    /* Patient Info */
    .patient-info {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .patient-info h3 {
        font-size: 1.2rem;
        color: #1e3a5f;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .patient-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .patient-item {
        display: flex;
        flex-direction: column;
    }

    .patient-label {
        font-size: 0.8rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .patient-value {
        font-size: 1rem;
        color: #1e3a5f;
        font-weight: 600;
    }

    /* Check Items */
    .check-items-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .check-items-header {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .check-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 18px;
        margin-bottom: 12px;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .check-item:hover {
        background: white;
        border-color: #00796b;
    }

    .check-item.checked {
        background: #e8f5e9;
        border-color: #4caf50;
    }

    .check-item-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }

    .custom-checkbox {
        width: 28px;
        height: 28px;
        border: 3px solid #00796b;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .check-item.checked .custom-checkbox {
        background: #4caf50;
        border-color: #4caf50;
    }

    .custom-checkbox i {
        color: white;
        font-size: 1rem;
        display: none;
    }

    .check-item.checked .custom-checkbox i {
        display: block;
    }

    .medicine-name {
        font-size: 1.05rem;
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 8px;
    }

    .medicine-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .medicine-detail-item {
        font-size: 0.9rem;
        color: #666;
    }

    .medicine-detail-item strong {
        color: #00796b;
    }

    /* Progress Bar */
    .progress-bar-container {
        margin-bottom: 25px;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.9rem;
        color: #666;
    }

    .progress-bar {
        height: 12px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%);
        transition: width 0.5s ease;
    }

    /* Summary Panel */
    .summary-panel {
        background: #f8f9fa;
        padding: 18px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .summary-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1e3a5f;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #dee2e6;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-item strong {
        color: #666;
        font-size: 0.9rem;
    }

    .summary-item span {
        color: #1e3a5f;
        font-weight: 600;
    }

    /* Notes Section */
    .notes-section {
        margin-top: 20px;
    }

    .notes-section textarea {
        width: 100%;
        min-height: 100px;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        resize: vertical;
        transition: all 0.3s ease;
    }

    .notes-section textarea:focus {
        outline: none;
        border-color: #00796b;
        box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.1);
    }

    /* Action Buttons */
    .modal-actions {
        padding: 20px 25px;
        background: #f8f9fa;
        border-top: 2px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    /* Loading Overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(4px);
    }

    .loading-overlay.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loading-spinner {
        text-align: center;
        color: white;
    }

    .spinner {
        border: 4px solid rgba(255,255,255,0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state h4 {
        font-size: 1.3rem;
        margin-bottom: 10px;
        color: #666;
    }

    /* Filter Section */
    .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }

    .form-control {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #00796b;
        box-shadow: 0 0 0 3px rgba(0, 121, 107, 0.1);
    }

    .filter-actions {
        display: flex;
        gap: 10px;
    }

    /* Status Badge */
    .status-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
    }

    .status-da-capphat {
        background: #e8f5e9;
        color: #2e7d32;
    }

    /* Responsive */
    @@media (max-width: 1200px) {
        .modal-split {
            grid-template-columns: 1fr 350px;
        }
    }

    @@media (max-width: 992px) {
        .modal-split {
            grid-template-columns: 1fr;
        }

        .modal-right {
            border-left: none;
            border-top: 2px solid #e0e0e0;
        }
    }

    @@media (max-width: 768px) {
        .dispensing-container {
            padding: 15px;
        }

        .quick-stats {
            grid-template-columns: 1fr;
        }

        .patient-grid {
            grid-template-columns: 1fr;
        }

        .medicine-details {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="dispensing-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1>
            <i class="fas fa-hand-holding-medical"></i>
            Cấp Phát Thuốc
        </h1>
        <p>Hệ thống cấp phát thuốc cho bệnh nhân - Dược sĩ: <strong>@maNhanVien</strong></p>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-icon warning">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="quick-stat-info">
                <h3>@donChoCapPhat</h3>
                <p>Đơn chờ cấp phát</p>
            </div>
        </div>

        <div class="quick-stat">
            <div class="quick-stat-icon success">
                <i class="fas fa-check-double"></i>
            </div>
            <div class="quick-stat-info">
                <h3>@donDaCapPhat</h3>
                <p>Đã cấp phát hôm nay</p>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="dispensing-tabs">
        <button class="tab-button active" onclick="switchTab('queue')">
            <i class="fas fa-list-ul"></i> Hàng đợi cấp phát
        </button>
        <button class="tab-button" onclick="switchTab('history')">
            <i class="fas fa-history"></i> Lịch sử cấp phát
        </button>
    </div>

    <!-- Queue Tab -->
    <div id="queueTab" class="tab-content active">
        <div class="queue-card">
            <div class="queue-header">
                <h3 class="queue-title">
                    <i class="fas fa-clipboard-list"></i>
                    Đơn thuốc chờ cấp phát
                </h3>
                <button class="btn btn-primary" onclick="loadQueuePrescriptions()">
                    <i class="fas fa-sync-alt"></i> Làm mới
                </button>
            </div>
            <div id="queueList">
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #00796b;"></i>
                    <p style="margin-top: 15px; color: #666;">Đang tải dữ liệu...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content">
        <div class="queue-card">
            <div class="queue-header">
                <h3 class="queue-title">
                    <i class="fas fa-history"></i>
                    Lịch sử cấp phát
                </h3>
            </div>

            <!-- Filter -->
            <div class="filter-section">
                <div class="filter-grid">
                    <div class="form-group">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" id="historyFromDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" id="historyToDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tìm kiếm</label>
                        <input type="text" id="historySearch" class="form-control" placeholder="Mã đơn, bệnh nhân...">
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="loadHistoryPrescriptions()">
                        <i class="fas fa-search"></i> Tìm kiếm
                    </button>
                </div>
            </div>

            <div id="historyList">
                <!-- History items will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Dispensing Modal -->
<div id="dispensingModal" class="dispensing-modal">
    <div class="modal-content-large">
        <div class="modal-header">
            <h2><i class="fas fa-pills"></i> Cấp Phát Thuốc</h2>
            <button class="close-btn" onclick="closeDispensingModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="modal-split">
            <!-- Left: Patient Info & Medicine List -->
            <div class="modal-left">
                <div id="patientInfoSection">
                    <!-- Patient info will be loaded here -->
                </div>
                <div id="checkItemsSection">
                    <!-- Check items will be loaded here -->
                </div>
            </div>

            <!-- Right: Summary -->
            <div class="modal-right" id="dispensingSummary">
                <!-- Summary will be loaded here -->
            </div>
        </div>

        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeDispensingModal()">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="btn btn-success" onclick="completeDispensing()">
                <i class="fas fa-check"></i> Hoàn tất cấp phát
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Đang xử lý...</p>
    </div>
</div>

<script>
    let currentTab = 'queue';
    let currentDispensingData = null;
    let checkedItems = new Set();

    // Initialize
    $(document).ready(function() {
        loadQueuePrescriptions();
        
        // Auto refresh queue every 30 seconds
        setInterval(function() {
            if (currentTab === 'queue' && !$('#dispensingModal').hasClass('show')) {
                loadQueuePrescriptions();
            }
        }, 30000);
    });

    // Switch tab
    function switchTab(tab) {
        currentTab = tab;
        $('.tab-button').removeClass('active');
        $('.tab-content').removeClass('active');
        
        if (tab === 'queue') {
            $('.tab-button:eq(0)').addClass('active');
            $('#queueTab').addClass('active');
            loadQueuePrescriptions();
        } else {
            $('.tab-button:eq(1)').addClass('active');
            $('#historyTab').addClass('active');
            loadHistoryPrescriptions();
        }
    }

    // Load queue prescriptions
    function loadQueuePrescriptions() {
        $.ajax({
            url: '/DonThuoc/DanhSachDonThuoc',
            method: 'GET',
            data: { trangThai: 'ChoCapPhat' },
            success: function(response) {
                if (response.success) {
                    renderQueueList(response.data);
                } else {
                    showError('Lỗi khi tải hàng đợi');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                showError('Lỗi khi tải hàng đợi');
            }
        });
    }

    // Render queue list
    function renderQueueList(data) {
        const container = $('#queueList');
        container.empty();

        if (!data || data.length === 0) {
            container.html(`
                <div class="empty-state">
                    <i class="fas fa-clipboard-check"></i>
                    <h4>Không có đơn chờ cấp phát</h4>
                    <p>Tất cả đơn thuốc đã được xử lý</p>
                </div>
            `);
            return;
        }

        data.forEach(function(item) {
            const isUrgent = isUrgentPrescription(item.ngayKeDon);
            const badgeClass = isUrgent ? 'badge-urgent' : 'badge-normal';
            const badgeText = isUrgent ? 'Khẩn cấp' : 'Bình thường';
            const ngayKe = formatDateTime(item.ngayKeDon);

            const html = `
                <div class="queue-item" onclick="openDispensingModal('${item.maDonThuoc}')">
                    <div class="queue-item-header">
                        <div class="queue-item-info">
                            <h4>${item.benhNhan}</h4>
                            <p>Mã đơn: ${item.maDonThuoc} | ${ngayKe}</p>
                        </div>
                        <span class="queue-item-badge ${badgeClass}">${badgeText}</span>
                    </div>

                    <div class="queue-item-details">
                        <div class="detail-box">
                            <i class="fas fa-user-md"></i>
                            <div>
                                <div class="detail-label">Bác sĩ</div>
                                <div class="detail-value">${item.bacSi}</div>
                            </div>
                        </div>

                        <div class="detail-box">
                            <i class="fas fa-pills"></i>
                            <div>
                                <div class="detail-label">Số loại thuốc</div>
                                <div class="detail-value">${item.soLoaiThuoc} loại</div>
                            </div>
                        </div>

                        <div class="detail-box">
                            <i class="fas fa-boxes"></i>
                            <div>
                                <div class="detail-label">Tổng số lượng</div>
                                <div class="detail-value">${item.tongSoLuong} viên/gói</div>
                            </div>
                        </div>

                        <div class="detail-box">
                            <i class="fas fa-tag"></i>
                            <div>
                                <div class="detail-label">Loại đơn</div>
                                <div class="detail-value">${item.loaiDon === 'NoiTru' ? 'Nội trú' : 'Ngoại trú'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="queue-item-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-success btn-sm" onclick="openDispensingModal('${item.maDonThuoc}')">
                            <i class="fas fa-hand-holding-medical"></i> Cấp phát ngay
                        </button>
                    </div>
                </div>
            `;

            container.append(html);
        });
    }

    // Open dispensing modal
    function openDispensingModal(maDonThuoc) {
        showLoading();
        checkedItems.clear();

        $.ajax({
            url: '/DonThuoc/ChiTietDonThuoc',
            method: 'GET',
            data: { maDonThuoc: maDonThuoc },
            success: function(response) {
                if (response.success) {
                    currentDispensingData = response.data;
                    renderDispensingModal(response.data);
                    $('#dispensingModal').addClass('show');
                } else {
                    showError(response.message);
                }
                hideLoading();
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                showError('Lỗi khi tải chi tiết đơn thuốc');
                hideLoading();
            }
        });
    }

    // Render dispensing modal
    function renderDispensingModal(data) {
        // Render patient info
        renderPatientInfo(data);
        
        // Render check items
        renderCheckItems(data);
        
        // Render summary
        renderDispensingSummary(data);
    }

    // Render patient info
    function renderPatientInfo(data) {
        const html = `
            <div class="patient-info">
                <h3><i class="fas fa-user-injured"></i> Thông tin bệnh nhân</h3>
                <div class="patient-grid">
                    <div class="patient-item">
                        <div class="patient-label">Mã bệnh nhân</div>
                        <div class="patient-value">${data.benhNhan.maBenhNhan}</div>
                    </div>
                    <div class="patient-item">
                        <div class="patient-label">Họ tên</div>
                        <div class="patient-value">${data.benhNhan.tenBenhNhan}</div>
                    </div>
                    <div class="patient-item">
                        <div class="patient-label">Ngày sinh</div>
                        <div class="patient-value">${formatDate(data.benhNhan.ngaySinh)}</div>
                    </div>
                    <div class="patient-item">
                        <div class="patient-label">Giới tính</div>
                        <div class="patient-value">${data.benhNhan.gioiTinh}</div>
                    </div>
                </div>
            </div>
        `;
        $('#patientInfoSection').html(html);
    }

    // Render check items
    function renderCheckItems(data) {
        let html = `
            <div class="check-items-container">
                <div class="check-items-header">
                    <i class="fas fa-pills"></i> Kiểm tra và cấp phát thuốc
                </div>
        `;

        data.chiTiet.forEach(function(item, index) {
            html += `
                <div class="check-item" id="checkItem${index}" onclick="toggleCheckItem(${index})">
                    <div class="check-item-header">
                        <div style="flex: 1;">
                            <div class="medicine-name">${item.tenThuoc}</div>
                            <div class="medicine-details">
                                <div class="medicine-detail-item">
                                    <strong>Số lượng:</strong> ${item.soLuong} ${item.donViTinh}
                                </div>
                                <div class="medicine-detail-item">
                                    <strong>Liều dùng:</strong> ${item.lieuDung || 'N/A'}
                                </div>
                                <div class="medicine-detail-item">
                                    <strong>Số ngày:</strong> ${item.soNgayDung || 'N/A'} ngày
                                </div>
                                <div class="medicine-detail-item">
                                    <strong>Cách dùng:</strong> ${item.cachDung || 'N/A'}
                                </div>
                            </div>
                        </div>
                        <div class="custom-checkbox">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </div>
            `;
        });

        html += `</div>`;
        $('#checkItemsSection').html(html);
    }

    // Render summary
    function renderDispensingSummary(data) {
        const totalItems = data.chiTiet.length;
        const checkedCount = checkedItems.size;
        const progress = totalItems > 0 ? (checkedCount / totalItems * 100) : 0;

        const html = `
            <div class="progress-bar-container">
                <div class="progress-label">
                    <span>Tiến độ cấp phát</span>
                    <span><strong>${checkedCount}/${totalItems}</strong></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
            </div>

            <div class="summary-panel">
                <div class="summary-title">
                    <i class="fas fa-info-circle"></i> Thông tin đơn thuốc
                </div>
                <div class="summary-item">
                    <strong>Mã đơn:</strong>
                    <span>${data.maDonThuoc}</span>
                </div>
                <div class="summary-item">
                    <strong>Ngày kê:</strong>
                    <span>${formatDate(data.ngayKeDon)}</span>
                </div>
                <div class="summary-item">
                    <strong>Loại đơn:</strong>
                    <span>${data.loaiDon === 'NoiTru' ? 'Nội trú' : 'Ngoại trú'}</span>
                </div>
                <div class="summary-item">
                    <strong>Tổng loại thuốc:</strong>
                    <span style="color: #00796b;">${totalItems}</span>
                </div>
            </div>

            ${data.chanDoan ? `
            <div class="summary-panel">
                <div class="summary-title">
                    <i class="fas fa-stethoscope"></i> Chẩn đoán
                </div>
                <p style="margin: 0; color: #495057; line-height: 1.6;">${data.chanDoan}</p>
            </div>
            ` : ''}

            <div class="notes-section">
                <div class="summary-title">
                    <i class="fas fa-sticky-note"></i> Ghi chú cấp phát
                </div>
                <textarea id="dispensingNotes" placeholder="Nhập ghi chú (nếu có)..."></textarea>
            </div>
        `;

        $('#dispensingSummary').html(html);
    }

    // Toggle check item
    function toggleCheckItem(index) {
        const $item = $('#checkItem' + index);
        
        if (checkedItems.has(index)) {
            checkedItems.delete(index);
            $item.removeClass('checked');
        } else {
            checkedItems.add(index);
            $item.addClass('checked');
        }

        renderDispensingSummary(currentDispensingData);
    }

    // Complete dispensing
    function completeDispensing() {
        if (!currentDispensingData) {
            showError('Không có dữ liệu cấp phát');
            return;
        }

        const totalItems = currentDispensingData.chiTiet.length;
        if (checkedItems.size < totalItems) {
            if (!confirm(`Bạn mới kiểm tra ${checkedItems.size}/${totalItems} loại thuốc. Bạn có chắc muốn hoàn tất?`)) {
                return;
            }
        }

        const ghiChu = $('#dispensingNotes').val();
        showLoading();

        $.ajax({
            url: '/DonThuoc/CapPhatThuoc',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                maDonThuoc: currentDispensingData.maDonThuoc,
                ghiChu: ghiChu
            }),
            success: function(response) {
                if (response.success) {
                    showSuccess('Cấp phát thuốc thành công!');
                    closeDispensingModal();
                    loadQueuePrescriptions();
                } else {
                    showError(response.message);
                }
                hideLoading();
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                showError('Lỗi khi cấp phát thuốc');
                hideLoading();
            }
        });
    }

    // Close modal
    function closeDispensingModal() {
        $('#dispensingModal').removeClass('show');
        currentDispensingData = null;
        checkedItems.clear();
    }

    // Load history
    function loadHistoryPrescriptions() {
        showLoading();

        const params = {
            trangThai: 'DaCapPhat',
            tuNgay: $('#historyFromDate').val(),
            denNgay: $('#historyToDate').val(),
            timKiem: $('#historySearch').val()
        };

        $.ajax({
            url: '/DonThuoc/DanhSachDonThuoc',
            method: 'GET',
            data: params,
            success: function(response) {
                if (response.success) {
                    renderHistoryList(response.data);
                } else {
                    showError('Lỗi khi tải lịch sử');
                }
                hideLoading();
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                showError('Lỗi khi tải lịch sử');
                hideLoading();
            }
        });
    }

    // Render history
    function renderHistoryList(data) {
        const container = $('#historyList');
        container.empty();

        if (!data || data.length === 0) {
            container.html(`
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <h4>Không có lịch sử</h4>
                    <p>Chưa có đơn thuốc nào được cấp phát</p>
                </div>
            `);
            return;
        }

        data.forEach(function(item) {
            const ngayKe = formatDateTime(item.ngayKeDon);

            const html = `
                <div class="queue-item" style="border-left-color: #4caf50;">
                    <div class="queue-item-header">
                        <div class="queue-item-info">
                            <h4>${item.benhNhan}</h4>
                            <p>Mã đơn: ${item.maDonThuoc} | ${ngayKe}</p>
                        </div>
                        <span class="status-badge status-da-capphat">Đã cấp phát</span>
                    </div>

                    <div class="queue-item-details">
                        <div class="detail-box">
                            <i class="fas fa-user-md"></i>
                            <div>
                                <div class="detail-label">Bác sĩ</div>
                                <div class="detail-value">${item.bacSi}</div>
                            </div>
                        </div>

                        <div class="detail-box">
                            <i class="fas fa-pills"></i>
                            <div>
                                <div class="detail-label">Số loại thuốc</div>
                                <div class="detail-value">${item.soLoaiThuoc} loại</div>
                            </div>
                        </div>

                        <div class="detail-box">
                            <i class="fas fa-boxes"></i>
                            <div>
                                <div class="detail-label">Tổng số lượng</div>
                                <div class="detail-value">${item.tongSoLuong} viên/gói</div>
                            </div>
                        </div>

                        <div class="detail-box">
                            <i class="fas fa-tag"></i>
                            <div>
                                <div class="detail-label">Loại đơn</div>
                                <div class="detail-value">${item.loaiDon === 'NoiTru' ? 'Nội trú' : 'Ngoại trú'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.append(html);
        });
    }

    // Utility functions
    function isUrgentPrescription(dateString) {
        const prescriptionDate = new Date(dateString);
        const now = new Date();
        const hoursDiff = (now - prescriptionDate) / (1000 * 60 * 60);
        return hoursDiff > 2;
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN');
    }

    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('vi-VN');
    }

    function showLoading() {
        $('#loadingOverlay').addClass('show');
    }

    function hideLoading() {
        $('#loadingOverlay').removeClass('show');
    }

    function showSuccess(message) {
        alert('✓ ' + message);
    }

    function showError(message) {
        alert('✗ ' + message);
    }

    // ESC to close modal
    $(document).keydown(function(e) {
        if (e.key === 'Escape') {
            closeDispensingModal();
        }
    });

    // Click outside to close
    $('#dispensingModal').click(function(e) {
        if (e.target === this) {
            closeDispensingModal();
        }
    });
</script>

</body>
</html>
